# R20-P06 â€” MCP client resource discovery/refresh/read (Worker)

- Timestamp (UTC): 2026-02-21T18:50:55Z
- Phase: P06 (Worker)
- Plan: `project-plans/gmerge-0.21.3/560550f5df78-plan.md`

## Scope delivered
Implemented MCP resource behavior in core MCP client/client-manager paths:
- capability-gated resource discovery (`resources/list`)
- registry population on discover
- resource refresh on `notifications/resources/list_changed`
- `readResource(uri)` support (`resources/read`)
- resource cleanup on disconnect and client error
- manager wiring to pass `Config.getResourceRegistry()` into `McpClient`

## TDD evidence

### RED evidence (tests introduced before implementation complete)
Command:

    npm run test --workspace @vybestack/llxprt-code-core -- src/tools/mcp-client.test.ts src/tools/mcp-client-manager.test.ts

Observed failures included:
- transform syntax failure in `mcp-client.ts` while adding resource APIs (`Unexpected "export"`)
- then behavior failures while implementation was incomplete, e.g.
  - `this.resourceRegistry.setResourcesForServer is not a function`
  - prior expectations around missing resource-aware behavior

This provided explicit failing test evidence before final green implementation.

### GREEN evidence
Command:

    npm run test --workspace @vybestack/llxprt-code-core -- src/tools/mcp-client.test.ts src/tools/mcp-client-manager.test.ts

Passing summary:
- `[OK] src/tools/mcp-client-manager.test.ts (6 tests)`
- `[OK] src/tools/mcp-client.test.ts (51 tests)`
- `Test Files 2 passed (2)`
- `Tests 57 passed (57)`

### Typecheck evidence
Command:

    npm run typecheck --workspace @vybestack/llxprt-code-core

Result:
- `tsc --noEmit`
- Exit code `0`

## Files changed in this phase
- `packages/core/src/tools/mcp-client.ts`
- `packages/core/src/tools/mcp-client.test.ts`
- `packages/core/src/tools/mcp-client-manager.ts`
- `packages/core/src/tools/mcp-client-manager.test.ts`

## Notes
- Kept scope to P06 core MCP client and manager resource behavior only.
- CLI `@` attachment/completion/status remains for later phases (P08+).
