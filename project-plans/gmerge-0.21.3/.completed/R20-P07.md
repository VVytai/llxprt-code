# R20-P07 — Verifier (MCP client resource slice)

- Timestamp (UTC): 2026-02-21T19:05:00Z
- Phase: P07 (Verifier)
- Plan: `project-plans/gmerge-0.21.3/560550f5df78-plan.md`
- Input marker verified: `project-plans/gmerge-0.21.3/.completed/R20-P06.md`

## Verdict
PASS

## Verification scope checked
Per request, verified P06 evidence and code changes against plan requirements only:
1. Capability gating
2. Discovery / refresh / read behavior
3. Cleanup

Inspected files:
- `packages/core/src/tools/mcp-client.ts`
- `packages/core/src/tools/mcp-client.test.ts`
- `packages/core/src/tools/mcp-client-manager.ts`
- `packages/core/src/tools/mcp-client-manager.test.ts`

## Evidence and consistency

### 1) Capability gating — PASS
- `mcp-client.ts` gates resource discovery: `discoverResources()` delegates to `discoverResources(serverName, client)`; implementation uses server capabilities before listing resources.
- Notification handler registration for resources is gated by `capabilities?.resources?.listChanged`.
- Tests in `mcp-client.test.ts` cover:
  - Resource notification handler setup when supported.
  - No tool-related overreach in this slice.

### 2) Discovery / refresh / read — PASS
- Discovery:
  - `McpClient.discover()` now includes resources and updates resource registry via `updateResourceRegistry(resources)`.
  - Empty discovery failure condition includes resources (`No prompts, tools, or resources found on the server.`).
- Refresh:
  - `registerNotificationHandlers()` wires `ResourceListChangedNotificationSchema` to `refreshResources()`.
  - `refreshResources()` re-discovers resources and updates registry; emits feedback on success.
  - Coalescing flags (`isRefreshingResources`, `pendingResourceRefresh`) are implemented.
- Read:
  - `readResource(uri)` implemented via `client.request({ method: 'resources/read', params: { uri } }, ReadResourceResultSchema)`.
- Tests in `mcp-client.test.ts` validate:
  - Resource-only server discovery populates registry.
  - Resource list change notification refreshes registry and emits feedback.
  - `readResource` request shape and schema usage.
  - `readResource` throws while disconnected.

### 3) Cleanup — PASS
- `mcp-client.ts` removes resources on:
  - explicit `disconnect()` via `resourceRegistry.removeResourcesByServer(serverName)`
  - client `onerror` path (alongside tools/prompts cleanup)
- `mcp-client-manager.ts` passes `this.cliConfig.getResourceRegistry()` into `McpClient` construction.
- Tests in `mcp-client.test.ts` verify resource cleanup on disconnect and on error.
- `mcp-client-manager.test.ts` includes `getResourceRegistry` in config stubs, consistent with constructor wiring.

## P06 marker completeness/evidence check
- Marker exists and is complete: `R20-P06.md` present with scope, RED/GREEN/typecheck evidence, changed files list, and notes.
- Targeted test evidence in marker:
  - `npm run test --workspace @vybestack/llxprt-code-core -- src/tools/mcp-client.test.ts src/tools/mcp-client-manager.test.ts`
  - Reported passing totals are consistent with the test files inspected.
- Typecheck evidence in marker:
  - `npm run typecheck --workspace @vybestack/llxprt-code-core` with exit code 0.
- Changed-file list in marker matches the requested file set and observed code updates.

## Conclusion
P06 implementation and evidence match the requested plan requirements for the MCP client resource slice (capability gating, discovery/refresh/read, cleanup).