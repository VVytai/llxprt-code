# R20-P08 â€” @ command processor resource attachment (Worker)

- Timestamp (UTC): 2026-02-21T19:06:30Z
- Phase: P08 (Worker)
- Plan: `project-plans/gmerge-0.21.3/560550f5df78-plan.md`

## Scope delivered
Added MCP resource-aware `@` attachment handling in CLI `atCommandProcessor` while preserving file attachment behavior.

Implemented behavior:
- Detect `@serverName:uri` references by checking resource registry (`findResourceByUri`).
- Read matching resources via MCP client manager (`getClient(serverName).readResource(uri)`).
- Append resource content into processed query as:
  - `\nContent from @serverName:uri:\n`
  - converted resource content parts (text or binary placeholder)
- Preserve existing file `@path` flow and merge tool display entries in a single tool group.
- Fail fast with error tool entry if resource read client is unavailable or read fails.

Also added core support needed by CLI integration:
- `McpClientManager.getClient(name)` accessor.

## TDD evidence

### RED evidence
Command:

    npm run test --workspace @vybestack/llxprt-code -- src/ui/hooks/atCommandProcessor.test.ts

Failing test added first:
- `should include MCP resource content for @server:uri references`
- Failure showed resource path not invoked (e.g. `findResourceByUri` not called), proving behavior absent before implementation.

### GREEN evidence
Command:

    npm run test --workspace @vybestack/llxprt-code -- src/ui/hooks/atCommandProcessor.test.ts

Passing summary:
- `[OK] src/ui/hooks/atCommandProcessor.test.ts (41 tests)`
- `Test Files 1 passed (1)`
- `Tests 41 passed (41)`

### Typecheck evidence
Commands:

    npm run typecheck --workspace @vybestack/llxprt-code-core
    npm run typecheck --workspace @vybestack/llxprt-code

Results:
- both passed with exit code `0`.

## Files changed in this phase
- `packages/cli/src/ui/hooks/atCommandProcessor.ts`
- `packages/cli/src/ui/hooks/atCommandProcessor.test.ts`
- `packages/core/src/tools/mcp-client-manager.ts`

## Notes
- Type declarations consumed by CLI required core build refresh after adding manager accessor.
- Changes are limited to P08 scope (resource attachments in `@` command path).
