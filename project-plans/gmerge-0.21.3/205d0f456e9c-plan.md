# Plan: Fix GitHub API 415 Error for Source Tarballs (Commit 205d0f456e9c)

Plan ID: PLAN-20250219-GMERGE021.R14
Generated: 2025-02-19
Total Phases: 5
Requirements: REQ-R14-001 (Accept header differentiation), REQ-R14-002 (downloadFile robustness), REQ-R14-003 (TDD coverage)

## Critical Reminders

Before implementing ANY phase, ensure you have:

1. Completed preflight verification (Phase P00)
2. Written failing tests BEFORE implementing any code change
3. Verified all dependencies and types exist as assumed
4. Confirmed no adjacent branches touch `downloadFromGitHubRelease` or `downloadFile`

---

# Phase P00: Preflight Verification

## Phase ID

`PLAN-20250219-GMERGE021.R14.P00`

## Purpose

Verify ALL assumptions before writing any code.

## Upstream Commit Context

**Upstream Commit:** 205d0f456e9c5e6d90de71b1ad8d8ee844add6a9
**Date:** Thu Dec 4 10:16:08 2025
**PR:** #13319
**Issue:** GitHub API returns 415 Unsupported Media Type when downloading source tarballs

### Root Cause

The current implementation uses `Accept: application/octet-stream` for **all** GitHub download requests. GitHub's API requires different Accept headers depending on the download type:

| Download Type | Required Accept Header | GitHub Response |
|---|---|---|
| Binary assets (release artifacts) | `application/octet-stream` | Raw binary content |
| Source tarballs (`tarball_url`) | `application/vnd.github+json` | 302 redirect to `codeload.github.com` |
| Source zipballs (`zipball_url`) | `application/vnd.github+json` | 302 redirect to `codeload.github.com` |

Sending `application/octet-stream` for tarball/zipball requests causes GitHub to return **415 Unsupported Media Type**.

## Dependency Verification

| Dependency | Verification Command | Status |
|---|---|---|
| `node:https` | `node -e "require('node:https')"` | Must be OK (Node built-in) |
| `node:fs` | `node -e "require('node:fs')"` | Must be OK (Node built-in) |
| Vitest | `npm ls vitest` | Must be present |

## LLxprt Divergence Check

| Divergence | Details | Conflict? |
|---|---|---|
| User-Agent casing | `fetchJson` uses `'User-Agent'`; `downloadFile` uses `'User-agent'` | No — HTTP headers are case-insensitive; do not change in this PR |
| Package namespacing | Imports use `@vybestack/llxprt-code-core` | No conflict with HTTP download change |
| Adjacent branches | No other pending branch touches `downloadFromGitHubRelease` or `downloadFile` | Must verify before starting |

## Type/Interface Verification

| Type Name | Expected Definition | Location to Check |
|---|---|---|
| `DownloadOptions` | Does NOT exist yet; will be added as internal interface | `packages/cli/src/config/extensions/github.ts` |
| `IncomingMessage` | Exists in `node:https` response callback | Node built-in |

## Call Path Verification

| Function | File | Approximate Line |
|---|---|---|
| `downloadFile` | `packages/cli/src/config/extensions/github.ts` | ~493 |
| `downloadFromGitHubRelease` | `packages/cli/src/config/extensions/github.ts` | ~343 |
| `fetchJson` | Same file | Earlier in file |

## Test Infrastructure Verification

| Component | Test File | Vitest Hoisting Pattern |
|---|---|---|
| `github.test.ts` | `packages/cli/src/config/extensions/github.test.ts` | `vi.hoisted` / `vi.mock` already used for `node:os` and `simple-git` |
| `node:https` mock | NOT present yet | Must add hoisted mock |

## Blocking Issues to Check

- [ ] Confirm `downloadFile` is near line 493 (grep before starting)
- [ ] Confirm `downloadFromGitHubRelease` is near line 343 (grep before starting)
- [ ] Confirm `node:https` is NOT currently mocked in `github.test.ts`
- [ ] Confirm no open PR touches `downloadFile` or `downloadFromGitHubRelease`

## Verification Gate

- [ ] All dependencies verified
- [ ] Target functions located at expected positions
- [ ] No adjacent branch conflict
- [ ] Test infrastructure ready for `node:https` mock

**IF ANY CHECKBOX IS UNCHECKED: STOP and update plan before proceeding.**

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P00.md`

---

# Phase P01: TDD — Write Failing Tests for `downloadFile`

## Phase ID

`PLAN-20250219-GMERGE021.R14.P01`

## Prerequisites

- Required: Phase P00 completed
- Verification: `project-plans/gmerge-0.21.3/.completed/P00.md` exists
- Preflight gate passed: all checkboxes in P00 are checked

## Requirements Implemented (Expanded)

### REQ-R14-003: TDD Coverage for `downloadFile`

**Full Text**: Every behavioral change to `downloadFile` must be covered by a failing test written BEFORE the implementation change is made.

**Behavior**:
- GIVEN: `downloadFile` has no test coverage
- WHEN: Tests are written and run against the current (unmodified) implementation
- THEN: Tests fail in expected ways (wrong headers, missing redirect logic, missing error handling)

**Why This Matters**: Without failing tests first, there is no evidence the implementation actually changed behavior.

## Implementation Tasks

### Files to Modify

- `packages/cli/src/config/extensions/github.test.ts`
  - ADD hoisted `node:https` mock at top of file alongside existing mocks
  - ADD `describe('downloadFile', ...)` block with 10 test cases
  - Implements: `@requirement:REQ-R14-003`
  - ADD marker: `@plan:PLAN-20250219-GMERGE021.R14.P01`

### Required Code Markers

Every test function MUST include the plan marker:

```typescript
/**
 * @plan PLAN-20250219-GMERGE021.R14.P01
 * @requirement REQ-R14-003
 */
```

### Mocking Strategy

Add at the top of the test file alongside existing `vi.mock` calls:

```typescript
const mockHttpsGet = vi.hoisted(() => vi.fn());
vi.mock('node:https', () => ({
  get: mockHttpsGet,
}));
```

### Helper Factory

```typescript
function makeMockResponse(
  statusCode: number,
  headers: Record<string, string> = {},
) {
  const events: Record<string, (...args: unknown[]) => void> = {};
  const response = {
    statusCode,
    headers,
    on: (event: string, cb: (...args: unknown[]) => void) => {
      events[event] = cb;
    },
    pipe: (dest: { on: (...args: unknown[]) => void }) => {
      void dest;
      setImmediate(() => events['finish']?.());
    },
  };
  return response;
}
```

### Tests to Write (all must FAIL before P02 implementation)

**Test 1 — Default headers are `application/octet-stream`:**
- Call `downloadFile('https://example.com/file', '/tmp/dest')` (no options)
- Assert `mockHttpsGet` received `{ headers: { 'User-agent': 'gemini-cli', Accept: 'application/octet-stream' } }`
- **Expected failure mode:** Test likely passes trivially or cannot call the function if it is not exported; mark as needing an export or test via integration

**Test 2 — Caller headers override defaults:**
- Call with `options: { headers: { Accept: 'application/vnd.github+json' } }`
- Assert `mockHttpsGet` received `Accept: 'application/vnd.github+json'`
- **Expected failure mode:** `downloadFile` does not accept an `options` parameter yet

**Test 3 — Follows 302 redirect (absolute Location):**
- First call returns 302 with `Location: 'https://codeload.github.com/file'`
- Second call returns 200
- Assert `mockHttpsGet` called twice
- **Expected failure mode:** Current impl may not handle redirects at all, or does so without the new signature

**Test 4 — Follows 307 and 308 redirects:**
- As Test 3 but with status 307 and separately 308
- **Expected failure mode:** 307/308 not in the current redirect handling

**Test 5 — Resolves relative Location against current URL:**
- First call to `https://api.github.com/repos/o/r/tarball/v1` returns 302 with `Location: '/repos/o/r/tarball/v1/resolved'`
- Assert second call uses `https://api.github.com/repos/o/r/tarball/v1/resolved`
- **Expected failure mode:** Current impl passes raw relative URL to recursive call

**Test 6 — Rejects after 10 redirects (boundary):**
- Mock always returns 302 with a valid Location
- Assert promise rejects with `'Too many redirects'`
- Assert exactly 10 `https.get` calls made (policy: `redirectCount >= 10`)
- **Expected failure mode:** Current impl has no redirect limit

**Test 7 — Rejects when redirect has no Location header:**
- Mock returns 302 with `headers: {}`
- Assert rejects with `'Redirect response missing Location header'`
- Assert `mockHttpsGet` called only once
- **Expected failure mode:** Current impl will crash or hang without Location

**Test 8 — Rejects on non-200 non-redirect with status code in message:**
- Mock returns 404
- Assert rejects with message containing `'404'`
- **Expected failure mode:** Current impl may not include status code in error

**Test 9 — Rejects on write-stream error:**
- Mock returns 200; mock `fs.createWriteStream` to emit `'error'` event
- Assert promise rejects
- **Expected failure mode:** Current impl has no `file.on('error', ...)` handler

**Test 10 — Authorization header included when `GITHUB_TOKEN` set:**
- Set `process.env.GITHUB_TOKEN = 'test-token'`
- Assert `mockHttpsGet` receives `Authorization: 'token test-token'`
- Restore env after test
- **Expected failure mode:** Passes if token handling already exists; still valuable regression coverage

## Verification Commands

### Automated Checks (Structural)

```bash
# Confirm plan markers are present
grep -r "@plan:PLAN-20250219-GMERGE021.R14.P01" packages/cli/src/config/extensions/github.test.ts | wc -l
# Expected: 10+ occurrences

# Confirm https mock is hoisted
grep "vi.hoisted" packages/cli/src/config/extensions/github.test.ts | grep -c "mockHttpsGet"
# Expected: 1
```

### Structural Verification Checklist

- [ ] `node:https` mock added as hoisted `vi.fn()`
- [ ] `makeMockResponse` helper factory defined
- [ ] All 10 test cases present in `describe('downloadFile', ...)`
- [ ] All tests tagged with `@plan:PLAN-20250219-GMERGE021.R14.P01`
- [ ] No implementation changes made yet (tests only)

### Run Failing Tests

```bash
npm run test -- --grep "downloadFile"
# Expected: Most tests FAIL — this is correct and required before proceeding to P02
```

### Deferred Implementation Detection

```bash
# Confirm no implementation was changed in this phase
git diff packages/cli/src/config/extensions/github.ts
# Expected: No diff (only github.test.ts should have changes)
```

## Semantic Verification Checklist

1. **Does the code DO what the requirement says?**
   - [ ] Each test asserts an observable behavior (headers, redirect count, error message)
   - [ ] No test merely checks that a function was called without asserting outcomes

2. **Is this REAL test code, not placeholder?**
   - [ ] No empty `it('...')` blocks
   - [ ] No `it.skip(...)` or `it.todo(...)`

3. **Would each test FAIL if implementation was removed?**
   - [ ] Tests verified to fail by running them now

4. **Is the test reachable?**
   - [ ] `downloadFile` is either exported for direct testing or tested via `downloadFromGitHubRelease`

## Success Criteria

- 10 new tests exist in `github.test.ts` under `describe('downloadFile', ...)`
- Running `npm run test -- --grep "downloadFile"` shows the tests exist and most/all fail
- `git diff packages/cli/src/config/extensions/github.ts` shows no implementation changes

## Failure Recovery

If this phase fails:
1. `git checkout -- packages/cli/src/config/extensions/github.test.ts`
2. Review why tests cannot be written (e.g., `downloadFile` not accessible)
3. Resolve accessibility issue in P00 preflight update, then re-run P01

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P01.md`

---

# Phase P02: TDD — Write Failing Tests for `downloadFromGitHubRelease`

## Phase ID

`PLAN-20250219-GMERGE021.R14.P02`

## Prerequisites

- Required: Phase P01 completed
- Verification: `project-plans/gmerge-0.21.3/.completed/P01.md` exists
- All P01 tests confirmed failing

## Requirements Implemented (Expanded)

### REQ-R14-001: Accept Header Differentiation (Test Coverage)

**Full Text**: `downloadFromGitHubRelease` must use `application/octet-stream` when downloading binary release assets and `application/vnd.github+json` when downloading source tarballs or zipballs.

**Behavior**:
- GIVEN: A release with a matching binary asset
- WHEN: `downloadFromGitHubRelease` is called
- THEN: The download uses `Accept: application/octet-stream`

- GIVEN: A release with no matching binary asset, only `tarball_url`
- WHEN: `downloadFromGitHubRelease` is called
- THEN: The download uses `Accept: application/vnd.github+json`

**Why This Matters**: GitHub returns 415 Unsupported Media Type when the wrong Accept header is sent for tarball/zipball URLs.

## Implementation Tasks

### Files to Modify

- `packages/cli/src/config/extensions/github.test.ts`
  - ADD `describe('downloadFromGitHubRelease', ...)` block with 4 test cases
  - Implements: `@requirement:REQ-R14-001`
  - ADD marker: `@plan:PLAN-20250219-GMERGE021.R14.P02`

### Tests to Write (all must FAIL before P03 implementation)

**Test 11 — Uses `application/octet-stream` for binary asset:**
- Mock `fetchJson` to return a release with a matching platform asset
- Assert the download call uses `Accept: application/octet-stream`
- **Expected failure mode:** Current impl always uses `application/octet-stream` — test MAY pass accidentally; still required as regression guard

**Test 12 — Uses `application/vnd.github+json` for `tarball_url` fallback:**
- Mock release with no matching assets, only `tarball_url`
- Assert the download call uses `Accept: application/vnd.github+json`
- **Expected failure mode:** Current impl sends `application/octet-stream` → 415 error

**Test 13 — Uses `application/vnd.github+json` for `zipball_url` fallback:**
- Mock release with no assets and no `tarball_url`, only `zipball_url`
- Assert the download call uses `Accept: application/vnd.github+json`
- **Expected failure mode:** Same as Test 12

**Test 14 — Error message includes status code from failed download:**
- Mock download returns 403
- Assert `downloadFromGitHubRelease` rejects with a message containing `'403'`
- **Expected failure mode:** Current error message may not include status code

## Verification Commands

### Automated Checks (Structural)

```bash
# Confirm P02 plan markers exist
grep -r "@plan:PLAN-20250219-GMERGE021.R14.P02" packages/cli/src/config/extensions/github.test.ts | wc -l
# Expected: 4+ occurrences

# Run all new tests (confirm they exist and most fail)
npm run test -- --grep "downloadFromGitHubRelease"
# Expected: Tests exist; Tests 12 and 13 FAIL; Test 11 may pass (acceptable)
```

### Structural Verification Checklist

- [ ] All 4 tests present in `describe('downloadFromGitHubRelease', ...)`
- [ ] All tests tagged with `@plan:PLAN-20250219-GMERGE021.R14.P02`
- [ ] No implementation changes made yet
- [ ] `git diff github.ts` shows no changes

## Semantic Verification Checklist

1. **Tests assert Accept header values, not just that code ran?**
   - [ ] Test 11 verifies `application/octet-stream` specifically
   - [ ] Tests 12/13 verify `application/vnd.github+json` specifically

2. **Tests 12 and 13 confirmed to FAIL right now?**
   - [ ] Run `npm run test -- --grep "tarball_url fallback"` and see FAIL output

## Success Criteria

- 4 new tests in `describe('downloadFromGitHubRelease', ...)`
- Tests 12 and 13 confirmed failing (415/wrong-header path)
- `git diff github.ts` shows no implementation changes

## Failure Recovery

If this phase fails:
1. `git checkout -- packages/cli/src/config/extensions/github.test.ts`
2. Re-read `downloadFromGitHubRelease` to understand current mock surface
3. Re-run P02

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P02.md`

---

# Phase P03: Implementation — `DownloadOptions`, `downloadFile`, `downloadFromGitHubRelease`

## Phase ID

`PLAN-20250219-GMERGE021.R14.P03`

## Prerequisites

- Required: Phases P01 and P02 completed
- Verification:
  - `project-plans/gmerge-0.21.3/.completed/P01.md` exists
  - `project-plans/gmerge-0.21.3/.completed/P02.md` exists
  - `npm run test -- --grep "downloadFile|downloadFromGitHubRelease"` shows failures for Tests 2–9 and 12–13

## Requirements Implemented (Expanded)

### REQ-R14-001: Accept Header Differentiation

**Full Text**: `downloadFromGitHubRelease` must use `application/octet-stream` for binary release assets and `application/vnd.github+json` for source tarballs and zipballs.

**Behavior**:
- GIVEN: The `asset` variable is non-null (a binary asset was matched)
- WHEN: `downloadFile` is called
- THEN: `{ Accept: 'application/octet-stream' }` is passed as `downloadHeaders`

- GIVEN: The `asset` variable is null (no binary asset matched)
- WHEN: `downloadFile` is called with `tarball_url` or `zipball_url`
- THEN: `{ Accept: 'application/vnd.github+json' }` is passed as `downloadHeaders`

**Why This Matters**: GitHub's API contract requires the correct Accept header; wrong headers cause a 415 error that silently blocks extension installs.

### REQ-R14-002: `downloadFile` Robustness

**Full Text**: `downloadFile` must support caller-controlled headers, enforce redirect limits, validate Location headers, resolve relative redirects, and handle write-stream errors.

**Behavior**:
- GIVEN: Caller passes `options.headers`
- WHEN: `downloadFile` builds request headers
- THEN: caller headers take precedence over defaults (spread defaults first, then options.headers)

- GIVEN: Server returns 10 or more redirect responses
- WHEN: `downloadFile` tracks `redirectCount`
- THEN: Rejects with `'Too many redirects'` without making the 11th request

- GIVEN: Server returns a redirect with no `Location` header
- WHEN: `downloadFile` checks `res.headers.location`
- THEN: Rejects with `'Redirect response missing Location header'`

- GIVEN: Server returns a relative `Location` path
- WHEN: `downloadFile` resolves the URL
- THEN: Uses `new URL(location, url).toString()` for the next request

- GIVEN: Write stream emits `'error'` event
- WHEN: `downloadFile` listens for stream events
- THEN: Promise rejects with the stream error

**Why This Matters**: Without these guards, partial downloads, infinite redirect loops, and silent failures can corrupt the extension installation process.

## Implementation Tasks

### Files to Modify

- `packages/cli/src/config/extensions/github.ts`
  - ADD internal `DownloadOptions` interface immediately before `downloadFile`
  - MODIFY `downloadFile` signature and body as specified below
  - MODIFY `downloadFromGitHubRelease` call site as specified below
  - ADD markers: `@plan:PLAN-20250219-GMERGE021.R14.P03`

### Step 1: Add `DownloadOptions` Interface

Add immediately before `downloadFile` (do NOT export — this is an internal utility):

```typescript
/**
 * @plan PLAN-20250219-GMERGE021.R14.P03
 * @requirement REQ-R14-002
 */
interface DownloadOptions {
  headers?: Record<string, string>;
}
```

### Step 2: Modify `downloadFile`

**New signature:**

```typescript
/**
 * @plan PLAN-20250219-GMERGE021.R14.P03
 * @requirement REQ-R14-002
 */
async function downloadFile(
  url: string,
  dest: string,
  options?: DownloadOptions,
  redirectCount = 0,
): Promise<void>
```

**Header merge order (caller overrides defaults):**

```typescript
const token = process.env.GITHUB_TOKEN;
const headers: Record<string, string> = {
  'User-agent': 'gemini-cli',
  Accept: 'application/octet-stream',
  ...(token ? { Authorization: `token ${token}` } : {}),
  ...(options?.headers ?? {}),
};
```

**Redirect handling (add 307/308 support):**

```typescript
if (
  res.statusCode === 301 || res.statusCode === 302 ||
  res.statusCode === 307 || res.statusCode === 308
) {
  if (redirectCount >= 10) {
    return reject(new Error('Too many redirects'));
  }
  const location = res.headers.location;
  if (!location) {
    return reject(new Error('Redirect response missing Location header'));
  }
  const resolvedUrl = new URL(location, url).toString();
  downloadFile(resolvedUrl, dest, options, redirectCount + 1)
    .then(resolve)
    .catch(reject);
  return;
}
```

**Non-200 error and stream error handling:**

```typescript
if (res.statusCode !== 200) {
  return reject(
    new Error(`Request failed with status code ${res.statusCode}`),
  );
}
const file = fs.createWriteStream(dest);
res.pipe(file);
file.on('finish', () => file.close(resolve as () => void));
file.on('error', reject);
```

**Note on 307/308:** Include these codes because GitHub's codeload CDN uses them. Preserving HTTP method is not a concern since all requests are GET.

**Note on partial files:** The `await fs.promises.unlink(downloadedAssetPath)` at the end of `downloadFromGitHubRelease` already swallows cleanup errors. Partial file cleanup is pre-existing behaviour and is **out of scope** for this PR.

### Step 3: Modify `downloadFromGitHubRelease`

Replace the current `downloadFile` call site:

```typescript
// Before:
await downloadFile(archiveUrl, downloadedAssetPath);

// After:
/**
 * @plan PLAN-20250219-GMERGE021.R14.P03
 * @requirement REQ-R14-001
 */
// Binary release assets require 'application/octet-stream'.
// Source tarballs and zipballs require 'application/vnd.github+json'
// because GitHub responds with a redirect to codeload.github.com.
const downloadHeaders = asset
  ? { Accept: 'application/octet-stream' }
  : { Accept: 'application/vnd.github+json' };
await downloadFile(archiveUrl, downloadedAssetPath, { headers: downloadHeaders });
```

The `asset` variable is already in scope and is non-null exactly when a binary asset was matched.

### Out of Scope (Do NOT Change)

- `User-Agent` vs `User-agent` casing inconsistency between `fetchJson` and `downloadFile` — pre-existing; out of scope
- Partial file cleanup on mid-stream failure — pre-existing; out of scope
- Auth-header pass-through policy for cross-host redirects — not required for public GitHub tarball downloads
- Scheme validation on redirect URLs — not required for this scope

## Verification Commands

### Run Previously Failing Tests (Must Now Pass)

```bash
npm run test -- --grep "downloadFile|downloadFromGitHubRelease"
# Expected: ALL 14 tests pass
```

### Deferred Implementation Detection (MANDATORY)

```bash
# Check for TODO/FIXME/HACK in modified files
grep -rn -E "(TODO|FIXME|HACK|STUB|XXX|TEMPORARY|TEMP|WIP)" \
  packages/cli/src/config/extensions/github.ts | grep -v ".test.ts"
# Expected: No new matches from this PR's changes

# Check for cop-out comments
grep -rn -E "(in a real|in production|ideally|for now|placeholder|not yet|will be|should be)" \
  packages/cli/src/config/extensions/github.ts | grep -v ".test.ts"
# Expected: No matches

# Check for empty/trivial implementations
grep -rn -E "return \[\]|return \{\}|return null|return undefined" \
  packages/cli/src/config/extensions/github.ts | grep -v ".test.ts"
# Expected: No matches from the new code paths
```

### Structural Verification Checklist

- [ ] `DownloadOptions` interface added and NOT exported
- [ ] `downloadFile` new signature has `options?: DownloadOptions` and `redirectCount = 0`
- [ ] Header merge spreads defaults first, then `options?.headers` last (caller wins)
- [ ] Redirect handling covers 301, 302, 307, 308
- [ ] `redirectCount >= 10` check present
- [ ] Missing `Location` header check present
- [ ] `new URL(location, url).toString()` used for redirect resolution
- [ ] `file.on('error', reject)` added to write stream
- [ ] `downloadFromGitHubRelease` passes `downloadHeaders` based on `asset` truthiness
- [ ] All three plan markers (`@plan:PLAN-20250219-GMERGE021.R14.P03`) added

## Semantic Verification Checklist

1. **Does the code DO what the requirement says?**
   - [ ] Read the header merge code — caller headers are spread AFTER defaults
   - [ ] Read the redirect block — all four codes (301/302/307/308) handled
   - [ ] Read the `redirectCount >= 10` check — 10th request is the last allowed
   - [ ] Read the `downloadFromGitHubRelease` change — `asset` truthiness controls header

2. **Is this REAL implementation, not placeholder?**
   - [ ] Deferred implementation detection passed (no TODO/HACK)
   - [ ] `DownloadOptions` interface has actual `headers` field
   - [ ] All redirect codes enumerated explicitly

3. **Would the tests FAIL if implementation was removed?**
   - [ ] Tests 2–9 verify behaviors that only exist post-implementation
   - [ ] Tests 12–13 verify the `application/vnd.github+json` path that was broken before

4. **Is the feature REACHABLE by users?**
   - [ ] `downloadFromGitHubRelease` is called by the extension install flow
   - [ ] The new header logic is on the same code path (no dead branch)

5. **Integration Points Verified:**
   - [ ] `downloadFile` receives `options` from `downloadFromGitHubRelease` correctly
   - [ ] Header merge produces correct `Accept` for both binary and tarball cases
   - [ ] Redirect chain correctly carries `options` through recursive calls

## Success Criteria

- All 14 tests pass: `npm run test -- --grep "downloadFile|downloadFromGitHubRelease"`
- Deferred implementation detection finds no issues
- All plan markers present in implementation code

## Failure Recovery

If this phase fails:
1. `git checkout -- packages/cli/src/config/extensions/github.ts`
2. Re-read test failures to understand which requirement is not met
3. Re-implement only the failing requirement, then re-run

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P03.md`

---

# Phase P04: Full Verification Suite

## Phase ID

`PLAN-20250219-GMERGE021.R14.P04`

## Prerequisites

- Required: Phase P03 completed
- Verification: `project-plans/gmerge-0.21.3/.completed/P03.md` exists
- All 14 new tests pass

## Requirements Implemented (Expanded)

### REQ-R14-003: Full Verification Gate

**Full Text**: All project verification steps must pass before the implementation is considered complete.

**Behavior**:
- GIVEN: All 14 tests pass
- WHEN: The full verification suite is run
- THEN: `npm run test`, `npm run typecheck`, `npm run lint`, `npm run format`, `npm run build`, and the haiku smoke test all succeed without errors

**Why This Matters**: A fix that breaks type-checking or the build is not a fix.

## Implementation Tasks

No new code is written in this phase. This phase executes all project-mandated verification steps and documents the results.

## Verification Commands

Run each command in sequence. Fix any failures before proceeding to the next.

```bash
# 1. Full test suite
npm run test
# Expected: All tests pass (including the 14 new ones)

# 2. Type-check
npm run typecheck
# Expected: No type errors

# 3. Lint
npm run lint
# Expected: No lint errors

# 4. Format
npm run format
# Expected: No formatting changes needed (or auto-fixed with no diff after)

# 5. Build
npm run build
# Expected: Build succeeds with no errors

# 6. Integration smoke test
node scripts/start.js --profile-load synthetic "write me a haiku"
# Expected: Haiku output produced without errors
```

### Plan Marker Audit

```bash
# Confirm all three phase markers exist in the codebase
grep -r "@plan:PLAN-20250219-GMERGE021.R14.P01" packages/cli/src/config/extensions/ | wc -l
# Expected: 10+

grep -r "@plan:PLAN-20250219-GMERGE021.R14.P02" packages/cli/src/config/extensions/ | wc -l
# Expected: 4+

grep -r "@plan:PLAN-20250219-GMERGE021.R14.P03" packages/cli/src/config/extensions/ | wc -l
# Expected: 3+
```

### Risk Assessment Verification

| Risk | Mitigation Verified By |
|---|---|
| Redirect handling breaks relative Location | Test 5 passes |
| Header merge order sends wrong Accept for tarballs | Test 2 passes |
| 307/308 redirects not followed | Test 4 passes |
| Write-stream errors silently lost | Test 9 passes |
| Partial file left on failure | Accepted as pre-existing; no new regression |
| `DownloadOptions` becoming unintentional public API | `grep -c "export.*DownloadOptions" github.ts` returns 0 |
| Recursive signature changing public contract | `downloadFile` is internal; `redirectCount` not exported |
| 401/403 from private repos | Test 8 (404 path) covers non-200 with status code; 401/403 follow same path |

```bash
# Verify DownloadOptions is not exported
grep -c "export.*DownloadOptions" packages/cli/src/config/extensions/github.ts
# Expected: 0

# Verify downloadFile is not exported
grep -c "export.*downloadFile" packages/cli/src/config/extensions/github.ts
# Expected: 0
```

### Structural Verification Checklist

- [ ] `npm run test` passes
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes
- [ ] `npm run format` passes (or auto-fixes and no remaining diff)
- [ ] `npm run build` passes
- [ ] Smoke test produces haiku output
- [ ] `DownloadOptions` confirmed unexported
- [ ] `downloadFile` confirmed unexported
- [ ] All plan phase markers present in codebase

### Semantic Verification Checklist

1. **All 14 tests verify actual behavior?**
   - [ ] Tests 1–10 cover `downloadFile` behavioral scenarios
   - [ ] Tests 11–14 cover `downloadFromGitHubRelease` Accept header selection and error propagation

2. **No deferred implementations remain?**
   - [ ] Deferred implementation detection from P03 still passes

3. **Feature reachable by users?**
   - [ ] The extension install flow calls `downloadFromGitHubRelease`
   - [ ] The fix is on the active code path, not behind a flag

4. **Edge cases verified?**
   - [ ] Redirect limit boundary (exactly 10 allowed, 11th rejected): Test 6
   - [ ] Missing Location header: Test 7
   - [ ] Relative Location: Test 5
   - [ ] Write-stream error: Test 9
   - [ ] Non-200 status: Test 8

#### Feature Actually Works

```bash
# Manual spot-check: confirm the Accept header difference is present in diff
git diff HEAD packages/cli/src/config/extensions/github.ts | grep -A2 -B2 "vnd.github"
# Expected: Shows the new downloadHeaders logic with 'application/vnd.github+json'
```

## Success Criteria

- All six verification commands pass without errors
- All 14 tests pass
- Plan marker audit finds expected counts
- `DownloadOptions` and `downloadFile` confirmed unexported
- No deferred implementation markers in modified files

## Failure Recovery

If any verification step fails:
1. Identify the failing command and its error output
2. Fix only the issue causing that failure (do not revert other changes)
3. Re-run the full sequence from step 1 until all pass
4. Do not commit until all six steps pass

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P04.md`

---

## Execution Tracker

`project-plans/gmerge-0.21.3/execution-tracker.md`

| Phase | ID | Status | Started | Completed | Verified | Semantic? | Notes |
|---|---|---|---|---|---|---|---|
| Preflight | P00 | [ ] | - | - | - | N/A | Verify file locations, no adjacent branch conflict |
| Failing tests — downloadFile | P01 | [ ] | - | - | - | [ ] | 10 failing tests; no impl changes |
| Failing tests — downloadFromGitHubRelease | P02 | [ ] | - | - | - | [ ] | 4 failing tests; no impl changes |
| Implementation | P03 | [ ] | - | - | - | [ ] | DownloadOptions + downloadFile + call site |
| Full verification | P04 | [ ] | - | - | - | [ ] | All 6 verification steps + marker audit |

## Completion Markers

- [ ] All phases have `@plan:PLAN-20250219-GMERGE021.R14.PNN` markers in code
- [ ] All 14 tests have `@requirement:REQ-R14-XXX` markers
- [ ] `npm run test` passes
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes
- [ ] `npm run format` passes
- [ ] `npm run build` passes
- [ ] Smoke test passes
- [ ] No phases skipped in sequence

---

## Files Modified Summary

| File | Phase | Changes |
|---|---|---|
| `packages/cli/src/config/extensions/github.ts` | P03 | Add internal `DownloadOptions` interface; update `downloadFile` signature/body; update `downloadFromGitHubRelease` call site |
| `packages/cli/src/config/extensions/github.test.ts` | P01, P02 | Add hoisted `node:https` mock; add `makeMockResponse` helper; add 14 new test cases across two describe blocks |

## Out of Scope (Do Not Address in This PR)

- `User-Agent` vs `User-agent` casing inconsistency between `fetchJson` and `downloadFile` (pre-existing; unrelated)
- Cleaning up partial files on mid-stream failure (pre-existing; would require restructuring the promise chain)
- Auth-header pass-through policy for cross-host redirects (not required for public GitHub tarball downloads)
- Scheme validation on redirect URLs (GitHub only redirects to codeload.github.com over HTTPS)
