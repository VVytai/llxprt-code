# Plan: feat(mcp): Add support for MCP Resources (560550f5df78)

Plan ID: PLAN-20250219-GMERGE021.R20  
Generated: 2026-02-20  
Total Phases: 16 (P00–P15)  
Upstream Commit: `560550f5df78` — feat: Add support for MCP Resources  
Scope Lock: **R20 MCP Resources only** (no expansion beyond MCP resource discovery, registry, read, `@` usage, completion, status/command visibility, docs, and required verification)

---

## 0. Execution Contract (Read First)

This plan is a strict, executable, phase-by-phase coordination plan under `dev-docs/COORDINATING.md`.

### Mandatory sequencing rules
1. **Do not skip phase numbers.**
2. Every implementation phase has a paired verifier phase immediately after it.
3. **Worker PASS + Verifier PASS** is required before moving to the next numbered phase.
4. If verifier fails, run remediation loop for that same phase until PASS (or declare blocked with evidence).
5. All worker and verifier phases use **Subagent: deepthinker** only.

### TDD contract for each implementation slice
For each feature slice:
1. Create/modify tests first (RED).
2. Run targeted tests and confirm failure for the intended behavior.
3. Implement minimum code to satisfy tests (GREEN).
4. Re-run targeted tests and pass.
5. Run required broader checks per phase.

### `.completed/` artifact contract
After each verifier PASS, create/update:
- `.completed/R20-PXX.md` for that phase number.
- Include: timestamp, summary, commands run, PASS evidence, and any remediation notes.

### Scope boundaries (global DO NOT)
- DO NOT implement non-R20 features.
- DO NOT refactor unrelated modules.
- DO NOT alter provider/model behavior unrelated to MCP Resources.
- DO NOT change naming conventions outside required touched files.
- DO NOT skip required verification commands listed in this plan.

---

## 1. TodoWrite Template (Use Up Front)

Create all todos at start (no omissions), including verifier phases, with exact subagent annotation.

```ts
TodoWrite({
  todos: [
    { id: 'P00', content: 'P00 Prerequisites & scope lock (Subagent: deepthinker)', status: 'pending' },
    { id: 'P01', content: 'P01 Verify prerequisites & scope lock (Subagent: deepthinker)', status: 'pending' },
    { id: 'P02', content: 'P02 Resource registry tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P03', content: 'P03 Verify resource registry slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P04', content: 'P04 Config registry plumbing tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P05', content: 'P05 Verify config plumbing slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P06', content: 'P06 MCP client resource discovery/refresh/read tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P07', content: 'P07 Verify MCP client resource slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P08', content: 'P08 @ command processor resource attachment tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P09', content: 'P09 Verify @ command processor slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P10', content: 'P10 @ completion resource suggestions tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P11', content: 'P11 Verify @ completion slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P12', content: 'P12 MCP status UI and /mcp command tests RED then GREEN (Subagent: deepthinker)', status: 'pending' },
    { id: 'P13', content: 'P13 Verify MCP status and command slice (Subagent: deepthinker)', status: 'pending' },
    { id: 'P14', content: 'P14 Docs + full project verification + haiku run (Subagent: deepthinker)', status: 'pending' },
    { id: 'P15', content: 'P15 Final verification, completion markers, handoff packet (Subagent: deepthinker)', status: 'pending' }
  ]
});
```

---

## 2. Strict Phase Plan

## Phase P00 — Prerequisites & Scope Lock (Worker)
**Subagent: deepthinker**

### Objective
Establish exact baseline and lock scope to R20 MCP Resources.

### Prerequisite checks
- Confirm repository clean enough to work (or note unrelated dirty files).
- Confirm target files exist or are intentionally created:
  - `dev-docs/COORDINATING.md`
  - `project-plans/gmerge-0.21.3/560550f5df78-plan.md`
- Confirm R20 gaps in codebase for resource support.

### Required actions
- Inspect upstream delta:
  - `git show --name-status 560550f5df78`
- Map current LLxprt status for:
  - resource registry module
  - config registry accessor
  - MCP client resource capability/discovery/read
  - `@` processor resource resolution
  - completion resource suggestions
  - status/command visibility
  - docs coverage

### Deliverables
- Gap matrix in `.completed/R20-P00.md` with explicit “in scope / out of scope”.
- Phase start and scope lock statement.

### Verification commands
- `git show --name-status 560550f5df78`
- `git status --short`

### Expected outcomes
- Clear list of missing R20 behaviors.
- No ambiguity on files/slices to modify.

### DO NOT
- Do not change code in this phase.

### Remediation/Rollback
- If commit unavailable or ambiguous, mark blocked with evidence in `.completed/R20-P00.md` and stop.

---

## Phase P01 — Verify P00 (Verifier)
**Subagent: deepthinker**

### Objective
Validate scope lock and prerequisites completeness.

### Checks
- `.completed/R20-P00.md` exists and includes:
  - upstream mapping evidence
  - R20-only scope statement
  - no unauthorized expansion
- Confirm no code changes occurred in P00.

### Expected PASS
- Scope is executable, unambiguous, and constrained to R20.

### Failure handling
- Return FAIL with missing checklist items.
- Remediate P00 only; re-verify.

### Marker
- `.completed/R20-P01.md`

---

## Phase P02 — Resource Registry Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Implement core resource registry with test-first split.

### Files
- Create: `packages/core/src/resources/resource-registry.ts`
- Create: `packages/core/src/resources/resource-registry.test.ts`
- Update exports: `packages/core/src/index.ts`

### TDD steps (mandatory)
1. Add failing behavioral tests for:
   - set/replace by server
   - lookup by `serverName:uri`
   - list all resources
   - remove server resources
   - clear all
2. Run targeted test file and capture RED.
3. Implement minimal registry and types to pass.
4. Re-run targeted tests for GREEN.
5. Run `npm run typecheck`.

### Deliverables
- Registry API and tests passing.
- `.completed/R20-P02.md` with RED→GREEN evidence.

### Verification commands
- `npm run test -- packages/core/src/resources/resource-registry.test.ts`
- `npm run typecheck`

### Expected outcomes
- Tests demonstrate behavior (not implementation details).
- Typecheck clean.

### DO NOT
- Do not touch MCP client or CLI in this phase.

### Remediation/Rollback
- If tests flaky/incorrect, fix tests first.
- If implementation overreaches, trim to registry-only behavior.

---

## Phase P03 — Verify P02 (Verifier)
**Subagent: deepthinker**

### Checks
- Test-first evidence exists (failing run then passing run).
- Registry semantics match requirements.
- Export wiring correct in `packages/core/src/index.ts`.

### PASS criteria
- Behavioral tests pass and cover replacement/lookup/cleanup.
- No unrelated file churn.

### Marker
- `.completed/R20-P03.md`

---

## Phase P04 — Config Plumbing Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Expose resource registry through config lifecycle.

### Files
- Update: `packages/core/src/config/config.ts`
- Update/add related tests in config test suite.

### TDD steps
1. Add failing tests for:
   - registry initialized in config lifecycle
   - accessor `getResourceRegistry()` availability
2. Run targeted config tests (RED).
3. Implement minimal config changes (GREEN).
4. Re-run targeted tests and typecheck.

### Deliverables
- Config accessor and initialization done.
- `.completed/R20-P04.md` with RED→GREEN logs.

### Verification commands
- `npm run test -- packages/core/src/config`
- `npm run typecheck`

### Expected outcomes
- No regression in existing config/MCP wiring.

### DO NOT
- Do not implement MCP resource discovery here.

### Remediation/Rollback
- If existing config tests regress, restore behavior and re-implement minimal accessor path.

---

## Phase P05 — Verify P04 (Verifier)
**Subagent: deepthinker**

### Checks
- `Config` lifecycle includes registry initialization.
- `getResourceRegistry()` works and is tested.
- No unrelated config behavior changes.

### Marker
- `.completed/R20-P05.md`

---

## Phase P06 — MCP Client Resource Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Add resource capability handling, discovery/refresh/read, and cleanup.

### Files
- `packages/core/src/tools/mcp-client.ts`
- `packages/core/src/tools/mcp-client.test.ts`
- `packages/core/src/tools/mcp-client-manager.ts`
- `packages/core/src/tools/mcp-client-manager.test.ts`

### TDD steps
1. Add failing tests for:
   - no capability → no resource ops
   - discovery populates registry
   - list-changed triggers refresh behavior
   - disconnect/error cleanup removes server resources
   - `readResource(uri)` call and error propagation
2. Run targeted MCP tests (RED).
3. Implement minimal behavior to pass (GREEN).
4. Re-run targeted tests + `npm run typecheck`.

### Deliverables
- MCP resource flows functioning and tested.
- `.completed/R20-P06.md` with RED→GREEN evidence.

### Verification commands
- `npm run test -- packages/core/src/tools/mcp-client.test.ts packages/core/src/tools/mcp-client-manager.test.ts`
- `npm run typecheck`

### Expected outcomes
- Existing tool/prompt discovery remains intact.

### DO NOT
- Do not alter unrelated MCP protocols or non-resource surfaces.

### Remediation/Rollback
- If refresh loop introduces instability, reduce to deterministic minimal coalescing consistent with existing patterns.

---

## Phase P07 — Verify P06 (Verifier)
**Subagent: deepthinker**

### Checks
- Capability gating correct.
- Registry population/refresh/cleanup verified.
- `readResource` path is test-covered.
- No regression in non-resource MCP behavior.

### Marker
- `.completed/R20-P07.md`

---

## Phase P08 — `@` Processor Resource Attachment Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Allow `@serverName:uri` attachments via MCP resource reads.

### Files
- `packages/cli/src/ui/hooks/atCommandProcessor.ts`
- `packages/cli/src/ui/hooks/atCommandProcessor.test.ts`

### TDD steps
1. Add failing tests for:
   - successful resource attachment
   - binary payload summary rendering
   - mixed file + resource references
   - missing client/resource read failure path
2. Run targeted test (RED).
3. Implement minimal support before filesystem fallback (GREEN).
4. Re-run targeted tests + `npm run typecheck`.

### Deliverables
- Resource-aware `@` processing with safe output conversion.
- `.completed/R20-P08.md` with RED→GREEN evidence.

### Verification commands
- `npm run test -- packages/cli/src/ui/hooks/atCommandProcessor.test.ts`
- `npm run typecheck`

### Expected outcomes
- File-only behavior preserved.

### DO NOT
- Do not redesign entire attachment pipeline.

### Remediation/Rollback
- If parsing conflicts with file paths, constrain resource match to explicit `server:uri` semantics.

---

## Phase P09 — Verify P08 (Verifier)
**Subagent: deepthinker**

### Checks
- Resource resolution precedence and fallback behavior valid.
- Binary/text formatting behavior tested.
- Existing file attachment tests still pass.

### Marker
- `.completed/R20-P09.md`

---

## Phase P10 — `@` Completion Resource Suggestions Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Merge resource suggestions into completion.

### Files
- `packages/cli/src/ui/hooks/useAtCompletion.ts`
- `packages/cli/src/ui/hooks/useAtCompletion.test.ts`

### TDD steps
1. Add failing tests for:
   - resource-only suggestions
   - file-only unchanged behavior
   - mixed suggestions and filtering/limits
2. Run targeted completion tests (RED).
3. Implement minimal merge/ranking behavior (GREEN).
4. Re-run targeted tests + `npm run typecheck`.

### Deliverables
- Suggestion entries in `serverName:uri` format integrated.
- `.completed/R20-P10.md` with RED→GREEN evidence.

### Verification commands
- `npm run test -- packages/cli/src/ui/hooks/useAtCompletion.test.ts`
- `npm run typecheck`

### Expected outcomes
- Responsiveness and limits preserved.

### DO NOT
- Do not change unrelated completion heuristics.

### Remediation/Rollback
- If ranking regresses, preserve existing ordering and append resource suggestions within limit.

---

## Phase P11 — Verify P10 (Verifier)
**Subagent: deepthinker**

### Checks
- Mixed suggestion behavior validated.
- File suggestion regressions absent.
- Format exactly `serverName:uri`.

### Marker
- `.completed/R20-P11.md`

---

## Phase P12 — MCP Status + `/mcp` Visibility Slice (TDD Worker)
**Subagent: deepthinker**

### Objective
Expose resource counts/details in status UI and `/mcp` output.

### Files
- `packages/cli/src/ui/components/views/McpStatus.tsx`
- `packages/cli/src/ui/components/views/McpStatus.test.tsx`
- `packages/cli/src/ui/components/views/__snapshots__/McpStatus.test.tsx.snap`
- `packages/cli/src/ui/commands/mcpCommand.ts`
- `packages/cli/src/ui/commands/mcpCommand.test.ts`

### TDD steps
1. Add failing tests/snapshot expectations for resource visibility.
2. Run targeted UI/command tests (RED).
3. Implement concise, non-breaking output updates (GREEN).
4. Re-run targeted tests + `npm run typecheck`.

### Deliverables
- Updated status and command outputs with tests/snapshots.
- `.completed/R20-P12.md` with RED→GREEN evidence.

### Verification commands
- `npm run test -- packages/cli/src/ui/components/views/McpStatus.test.tsx packages/cli/src/ui/commands/mcpCommand.test.ts`
- `npm run typecheck`

### Expected outcomes
- UI style consistent with existing patterns.

### DO NOT
- Do not redesign MCP status layout beyond resource visibility needs.

### Remediation/Rollback
- If snapshots unstable, tighten deterministic rendering and update snapshots intentionally.

---

## Phase P13 — Verify P12 (Verifier)
**Subagent: deepthinker**

### Checks
- MCP status and `/mcp` include resource information correctly.
- Snapshot and behavioral tests align.
- No unrelated UI command regressions.

### Marker
- `.completed/R20-P13.md`

---

## Phase P14 — Docs + Full Verification (Worker)
**Subagent: deepthinker**

### Objective
Document R20 behavior and run full required project verification sequence.

### Files
- `docs/tools/mcp-server.md`
- Optional tracking docs under `project-plans/gmerge-0.21.3/` as needed.

### Required verification commands (exact sequence)
1. `npm run test`
2. `npm run typecheck`
3. `npm run lint`
4. `npm run format`
5. `npm run build`
6. `node scripts/start.js --profile-load synthetic --prompt "write me a haiku"`

### Expected outcomes
- All commands pass.
- Haiku command executes successfully.

### Deliverables
- Docs updated with:
  - discovery behavior
  - `@server:uri` usage
  - any LLxprt-specific constraints
- `.completed/R20-P14.md` with command outputs summarized.

### DO NOT
- Do not add non-R20 docs.
- Do not skip haiku run.

### Remediation/Rollback
- On failure: fix only relevant R20 issues, then rerun full sequence from step 1.

---

## Phase P15 — Final Verification & Handoff (Verifier)
**Subagent: deepthinker**

### Objective
Final gate: confirm complete, ordered, compliant execution.

### Checks
- All phase markers exist: `.completed/R20-P00.md` … `.completed/R20-P15.md`.
- Every phase executed in order with no skips.
- TDD RED→GREEN evidence present for all implementation slices (P02, P04, P06, P08, P10, P12).
- Full verification and haiku run passed in P14.
- Scope remained R20-only.

### Final deliverables
- `.completed/R20-P15.md` containing:
  - completion checklist
  - consolidated command summary
  - known limitations (if any) within scope
  - explicit statement: “R20 MCP Resources scope complete”

### Failure handling
- If any requirement missing, FAIL and route to specific phase remediation; re-run P15 after fixes.

---

## 3. Remediation Loop Protocol (Applies to Every Verifier FAIL)

1. Do not advance phase number.
2. Open remediation worker task for the same phase (**Subagent: deepthinker**).
3. Re-run that phase’s required commands.
4. Re-run corresponding verifier phase (**Subagent: deepthinker**).
5. Repeat until PASS or blocked with evidence.

Blocked criteria must include:
- exact command/output
- why it prevents completion
- why no safe in-scope workaround exists

---

## 4. Completion Checklist

- [ ] P00–P15 executed with no skipped numbers  
- [ ] All worker phases use `(Subagent: deepthinker)`  
- [ ] All verifier phases use `(Subagent: deepthinker)`  
- [ ] All implementation slices preserve TDD RED→GREEN  
- [ ] `.completed/R20-P00.md` … `.completed/R20-P15.md` exist  
- [ ] Full verification suite + haiku run passed  
- [ ] Scope stayed limited to **R20 MCP Resources only**
