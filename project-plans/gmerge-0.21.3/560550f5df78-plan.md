# Plan: feat(mcp): Add support for MCP Resources (560550f5df78)

Plan ID: PLAN-20250219-GMERGE021.R20
Generated: 2026-02-20
Total Phases: 8 (P00–P07)
Upstream Commit: `560550f5df78` — feat: Add support for MCP Resources

## Critical Reminders

Before implementing ANY phase, ensure you have:

1. Completed preflight verification (P00) and file mapping
2. Written failing tests before implementation work in each behavior slice
3. Preserved LLxprt naming/policy conventions (`llxprt`, `@vybestack/...`, no Gemini-only assumptions)
4. Kept scope to MCP Resources support (no unrelated refactors)

---

## Phase P00: Preflight & Scope Lock

### Phase ID
`PLAN-20250219-GMERGE021.R20.P00`

### Purpose
Establish a concrete LLxprt-adapted scope before coding.

### Verification Tasks
- Confirm upstream scope:
  - `git show --name-status 560550f5df78`
- Confirm LLxprt gaps:
  - no `packages/core/src/resources/resource-registry.ts`
  - no `Config.getResourceRegistry()` in `packages/core/src/config/config.ts`
  - no MCP resource discovery/read surface in `packages/core/src/tools/mcp-client.ts`
  - no resource-aware `@` processing in `packages/cli/src/ui/hooks/atCommandProcessor.ts`
  - no resource suggestions in `packages/cli/src/ui/hooks/useAtCompletion.ts`

### Exit Criteria
- [ ] Gap matrix captured in notes
- [ ] No blocking architectural unknowns

---

## Phase P01: Core Resource Registry (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P01`

### Files
- Create: `packages/core/src/resources/resource-registry.ts`
- Create: `packages/core/src/resources/resource-registry.test.ts`
- Update exports in `packages/core/src/index.ts`

### Requirements
- Registry stores resources by `serverName + uri` key.
- Supports: set/replace per-server, find by `serverName:uri`, list all, remove by server, clear.
- Introduce typed model for discovered resource that includes server metadata.

### Test-first
- Write failing behavioral tests for replacement, lookup, cleanup semantics.

### Exit Criteria
- [ ] New tests fail first, then pass
- [ ] `npm run typecheck` clean

---

## Phase P02: Config Plumbing for Resource Registry (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P02`

### Files
- `packages/core/src/config/config.ts`

### Requirements
- Add registry field initialization in Config lifecycle.
- Add `getResourceRegistry()` accessor.
- Ensure existing config initialization and MCP manager wiring remain valid.

### Test-first
- Add/adjust tests asserting accessor availability and lifecycle initialization.

### Exit Criteria
- [ ] Config tests pass
- [ ] No regressions in existing MCP config tests

---

## Phase P03: MCP Client Resource Discovery/Refresh/Read (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P03`

### Files
- `packages/core/src/tools/mcp-client.ts`
- `packages/core/src/tools/mcp-client.test.ts`
- `packages/core/src/tools/mcp-client-manager.ts`
- `packages/core/src/tools/mcp-client-manager.test.ts`

### Requirements
- Detect MCP resource capabilities.
- Discover resources and populate registry on connect/discover.
- Handle list-changed notifications for resources (refresh loop with coalescing, similar to tool refresh behavior).
- Expose `readResource(uri)` on client for CLI consumption.
- Remove per-server resources on disconnect/error cleanup.

### Test-first
- Add failing tests for:
  - capability absent (no resource operations)
  - discover populates registry
  - refresh updates registry
  - disconnect/error removes resources
  - readResource call path and error handling

### Exit Criteria
- [ ] Core MCP tests pass (including new resource cases)
- [ ] Existing tool/prompt discovery behavior unchanged

---

## Phase P04: `@` Command Processor Resource Attachments (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P04`

### Files
- `packages/cli/src/ui/hooks/atCommandProcessor.ts`
- `packages/cli/src/ui/hooks/atCommandProcessor.test.ts`

### Requirements
- Resolve `@serverName:uri` against resource registry before filesystem resolution.
- Fetch resource content using `config.getMcpClientManager()?.getClient(server).readResource(uri)`.
- Convert resource payload to user-visible text parts; represent binary blobs safely (size + mime summary).
- Preserve existing file `@path` behavior and ignore filtering semantics.
- Surface tool-group display for resource reads; fail safely on resource read errors.

### Test-first
- Add failing behavioral tests for:
  - successful resource attachment
  - binary resource summary rendering
  - mixed file+resource references
  - missing client/resource read error path

### Exit Criteria
- [ ] atCommandProcessor tests pass
- [ ] Existing file-only `@` tests remain green

---

## Phase P05: `@` Completion Resource Suggestions (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P05`

### Files
- `packages/cli/src/ui/hooks/useAtCompletion.ts`
- `packages/cli/src/ui/hooks/useAtCompletion.test.ts`

### Requirements
- Merge resource suggestions with file suggestions.
- Resource suggestion value/label format: `serverName:uri`.
- Ensure filtering/ranking keeps responsiveness and respects current suggestion limits.

### Test-first
- Add failing tests for resource-only, file-only, and mixed suggestion cases.

### Exit Criteria
- [ ] completion tests pass
- [ ] no regressions in existing completion behavior

---

## Phase P06: MCP Status UI + `/mcp` visibility updates (TDD)

### Phase ID
`PLAN-20250219-GMERGE021.R20.P06`

### Files
- `packages/cli/src/ui/components/views/McpStatus.tsx`
- `packages/cli/src/ui/components/views/McpStatus.test.tsx`
- `packages/cli/src/ui/components/views/__snapshots__/McpStatus.test.tsx.snap`
- `packages/cli/src/ui/commands/mcpCommand.ts`
- `packages/cli/src/ui/commands/mcpCommand.test.ts`

### Requirements
- Display MCP resource counts/details consistent with LLxprt UI style.
- Keep command output concise and non-breaking.
- Ensure snapshots and behavioral expectations are updated intentionally.

### Exit Criteria
- [ ] UI tests/snapshots updated and passing
- [ ] `/mcp` command tests passing

---

## Phase P07: Documentation + Full Verification

### Phase ID
`PLAN-20250219-GMERGE021.R20.P07`

### Files
- `docs/tools/mcp-server.md`
- `project-plans/gmerge-0.21.3/{AUDIT.md,NOTES.md,PROGRESS.md}` as needed

### Requirements
- Document how MCP resources are discovered/referenced with `@server:uri`.
- Document any LLxprt-specific deviations from upstream behavior.

### Verification Commands (mandatory project workflow)
1. `npm run test`
2. `npm run typecheck`
3. `npm run lint`
4. `npm run format`
5. `npm run build`
6. `node scripts/start.js --profile-load synthetic --prompt "write me a haiku"`

### Exit Criteria
- [ ] Full verification suite green or pre-existing failures explicitly evidenced
- [ ] Docs updated
- [ ] Plan execution notes captured

---

## Risks & Mitigations

1. **Cross-layer regressions** (core + CLI simultaneously)
   - Mitigation: strict phase gates and targeted tests per phase.
2. **Resource payload variability** (text vs blob vs nested resource shape)
   - Mitigation: normalize content conversion and cover with tests.
3. **Performance noise in completion**
   - Mitigation: cap suggestions and reuse existing async/fuzzy flow.
4. **MCP client lifecycle leaks**
   - Mitigation: explicit cleanup tests on disconnect/error paths.

---

## Completion Markers

Create phase markers in `.completed/` as each phase passes:
- `R20-P00.md` … `R20-P07.md`
