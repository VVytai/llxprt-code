# Plan: Fuzzy Search Inside Settings Dialog

Plan ID: `PLAN-20250219-GMERGE021.R2`
Generated: 2025-02-19
Total Phases: 6
Source Commit: `344f2f26e78e`

## Critical Reminders

Before implementing ANY phase, ensure you have:

1. Completed preflight verification (Phase P01)
2. Written failing tests BEFORE implementation (Phase P02 before P03)
3. Verified all types and call paths exist as assumed in P01
4. Confirmed `fzf` package is already a dependency (it is — see `packages/cli/package.json`)

---

# Phase P01: Preflight Verification

## Phase ID

`PLAN-20250219-GMERGE021.R2.P01`

## Prerequisites

- None (this is the first phase)

## Purpose

Verify ALL assumptions before writing any code.

## Dependency Verification

| Dependency | Location | Status |
|------------|----------|--------|
| `fzf` | `packages/cli/package.json` | Verify with `npm ls fzf` |
| `Fzf` (sync) | `packages/cli/src/ui/utils/fuzzyFilter.ts` | Import pattern to copy |
| `AsyncFzf` | NOT used — use synchronous `Fzf` instead | N/A |

## Type / Interface Verification

| Symbol | Expected Location | What to Check |
|--------|-------------------|---------------|
| `getDialogSettingKeys()` | `SettingsDialog.tsx` (or imported) | Returns `string[]` |
| `getSettingDefinition(key)` | Existing util | Returns object with `.label: string` |
| `generateNormalSettingsItems()` | Inner function in `SettingsDialog.tsx` | Calls `getDialogSettingKeys()` on first line |
| `focusSection` | State in `SettingsDialog.tsx` | Value `'settings'` when main list is focused |
| `subSettingsMode.isActive` | State in `SettingsDialog.tsx` | Boolean guard |
| `editingKey` | State in `SettingsDialog.tsx` | Non-null when a setting is being edited |
| `keyMatchers[Command.ESCAPE]` | `keyMatchers` map in component | Used for escape key |
| `Colors.AccentBlue`, `Colors.Gray` | `Colors` import | Used for header theming |

## Call Path Verification

Confirm this exact data flow before touching anything:

```
getDialogSettingKeys()
  → generateNormalSettingsItems()
    → generateSettingsItems()
      → items  (const in component body)
        → visibleItems  (items.slice(scrollOffset, scrollOffset + maxItemsToShow))
```

Filtering must reduce `items` (not `visibleItems`) to keep scroll logic correct.

## Test Infrastructure Verification

| Component | Verify |
|-----------|--------|
| `SettingsDialog.test.tsx` exists | `ls packages/cli/src/ui/components/SettingsDialog.test.tsx` |
| `KeypressProvider` available in tests | Check existing test imports |
| `VimModeProvider` available in tests | Check existing test imports |
| `ink-testing-library` render pattern | Check existing `render(...)` calls |
| Vitest `vi.fn()` pattern | Confirm used for `onSelect` mock |

## Verification Commands

```bash
# Confirm fzf is installed
npm ls fzf --workspace=packages/cli

# Confirm fuzzyFilter.ts uses synchronous Fzf
grep "import.*Fzf" packages/cli/src/ui/utils/fuzzyFilter.ts

# Confirm Fzf constructor options in use
grep -A5 "new Fzf" packages/cli/src/ui/utils/fuzzyFilter.ts

# Confirm SettingsDialog data flow
grep -n "generateNormalSettingsItems\|generateSettingsItems\|visibleItems\|scrollOffset" \
  packages/cli/src/ui/components/SettingsDialog.tsx | head -40

# Confirm editingKey and focusSection state exist
grep -n "editingKey\|focusSection\|subSettingsMode" \
  packages/cli/src/ui/components/SettingsDialog.tsx | head -20
```

## Blocking Issues Found

_(Fill in during execution — stop and update plan if any found)_

- [ ] All dependencies verified
- [ ] All types match expectations
- [ ] Data flow confirmed: `getDialogSettingKeys → generateNormalSettingsItems → items → visibleItems`
- [ ] Key handler ordering understood (editingKey block → search block → navigation → digit intercept)
- [ ] Test infrastructure ready

**IF ANY CHECKBOX IS UNCHECKED: STOP and update plan before proceeding.**

## Success Criteria

- All verification commands run without error
- Data flow diagram confirmed against actual source
- No blocking mismatches found

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P01.md`

---

# Phase P02: Failing Tests (TDD)

## Phase ID

`PLAN-20250219-GMERGE021.R2.P02`

## Prerequisites

- Required: Phase P01 completed and all preflight gates passed
- Verification: `project-plans/gmerge-0.21.3/.completed/P01.md` exists

## Requirements Implemented (Expanded)

### REQ-SEARCH-001: Activate Search Mode with `/`

**Full Text**: Pressing `/` while the settings list has focus activates fuzzy search mode.
**Behavior**:
- GIVEN: SettingsDialog is open, `focusSection === 'settings'`, not editing, not in sub-settings
- WHEN: User presses `/`
- THEN: Header changes to `> Search: _` with a blinking cursor; all settings remain visible
**Why This Matters**: Discoverability — users with many settings need a fast way to find a specific one.

### REQ-SEARCH-002: Real-time Fuzzy Filtering

**Full Text**: As user types in search mode, the settings list filters using fuzzy matching against setting labels.
**Behavior**:
- GIVEN: Search mode is active
- WHEN: User types characters (e.g., `'vim'`)
- THEN: Only settings whose labels fuzzy-match the query are shown
**Why This Matters**: Fuzzy matching tolerates typos and partial labels.

### REQ-SEARCH-003: Backspace Editing in Search

**Full Text**: Pressing Backspace in search mode removes the last character from the query.
**Behavior**:
- GIVEN: Search mode active with query `'vim'`
- WHEN: User presses Backspace
- THEN: Query becomes `'vi'` and filtering updates
**Why This Matters**: Users need to correct their search without exiting and re-entering search mode.

### REQ-SEARCH-004: Escape Exits Search

**Full Text**: Pressing Escape exits search mode and restores the full settings list.
**Behavior**:
- GIVEN: Search mode active with any query
- WHEN: User presses Escape
- THEN: `isSearching` is false, query cleared, all settings visible, hint `(press / to search)` returns
**Why This Matters**: Standard escape-to-cancel UX convention.

### REQ-SEARCH-005: No Matches Empty State

**Full Text**: When no settings match the search query, show `No matches found.`
**Behavior**:
- GIVEN: Search mode active
- WHEN: Query matches no setting labels (e.g., `'zzzzzzz'`)
- THEN: `No matches found.` text is displayed instead of setting rows
**Why This Matters**: Without feedback, users don't know if there's a bug or no results.

### REQ-SEARCH-006: Guard — No Search During Editing

**Full Text**: Pressing `/` while a setting is being edited does NOT activate search mode.
**Behavior**:
- GIVEN: `editingKey` is non-null (user pressed Enter on a string/number setting)
- WHEN: User presses `/`
- THEN: Search mode is NOT activated; `/` is either added to the edit buffer or ignored
**Why This Matters**: `/` must be typeable inside text fields without triggering search.

### REQ-SEARCH-007: Guard — No Search in Sub-Settings Mode

**Full Text**: Pressing `/` while sub-settings are active does NOT activate search mode.
**Behavior**:
- GIVEN: `subSettingsMode.isActive === true`
- WHEN: User presses `/`
- THEN: Search mode is NOT activated
**Why This Matters**: Sub-settings has a different item list; searching would be confusing or broken.

### REQ-SEARCH-008: Navigation Works During Search

**Full Text**: Up/Down arrow keys navigate the filtered results during search.
**Behavior**:
- GIVEN: Search mode active with multiple results
- WHEN: User presses Down arrow
- THEN: `activeSettingIndex` increments (highlight moves down)
**Why This Matters**: Users must be able to reach and select a found setting without leaving search mode.

### REQ-SEARCH-009: Search Hint in Header

**Full Text**: When not searching, the header shows `(press / to search)` hint (except in sub-settings mode).
**Behavior**:
- GIVEN: SettingsDialog open, not in search mode, not in sub-settings
- WHEN: Dialog renders
- THEN: Header contains `(press / to search)`
**Why This Matters**: Discoverability — users need to know the feature exists.

### REQ-SEARCH-010: Enter Accepts Search

**Full Text**: Pressing Enter in search mode exits search mode but keeps the filter active.
**Behavior**:
- GIVEN: Search mode active with a valid query
- WHEN: User presses Enter
- THEN: `isSearching` becomes false (cursor/`>` prefix gone), filtered list remains visible
**Why This Matters**: Lets users narrow results then navigate without holding `/` mode.

## Implementation Tasks

### Files to Create

- `packages/cli/src/ui/components/SettingsDialog.test.tsx` — ADD test suite block `describe('fuzzy search', ...)` containing all required test cases below.
  - MUST include: `@plan:PLAN-20250219-GMERGE021.R2.P02`
  - MUST include requirement annotations on each `it()`

### Required Test Cases

Each test must be tagged: `@plan:PLAN-20250219-GMERGE021.R2.P02 @requirement:REQ-SEARCH-NNN`

```typescript
describe('fuzzy search @plan:PLAN-20250219-GMERGE021.R2.P02', () => {

  it('shows search hint in header by default @requirement:REQ-SEARCH-009', async () => {
    // Render SettingsDialog in normal mode
    // Assert header contains '(press / to search)'
    // Assert '> Search:' is NOT present
  });

  it('pressing / enters search mode @requirement:REQ-SEARCH-001', async () => {
    // Press '/' key
    // Assert header changes to show '> Search:'
    // Assert all settings still visible (no filter yet)
  });

  it('typing filters settings in real time @requirement:REQ-SEARCH-002', async () => {
    // Enter search mode, type a partial label (e.g. 'vim')
    // Assert only vim-related settings appear
    // Assert unrelated settings are NOT present
  });

  it('backspace removes last character from query @requirement:REQ-SEARCH-003', async () => {
    // Enter search mode, type 'vim'
    // Press Backspace (sequence '\x7F')
    // Assert query renders as 'vi' and filtering updates
  });

  it('Escape exits search and restores full list @requirement:REQ-SEARCH-004', async () => {
    // Enter search mode with query 'vim', press Escape
    // Assert full settings list returns
    // Assert '(press / to search)' hint is back
  });

  it('shows No matches found when nothing matches @requirement:REQ-SEARCH-005', async () => {
    // Enter search mode, type 'zzzzzzz'
    // Assert 'No matches found.' is displayed
  });

  it('Down arrow navigates filtered results during search @requirement:REQ-SEARCH-008', async () => {
    // Enter search mode with results, press Down arrow ('\u001B[B')
    // Assert active index changes (highlight moves)
  });

  it('Enter accepts search and exits search mode @requirement:REQ-SEARCH-010', async () => {
    // Enter search with valid query, press Enter ('\u000D')
    // Assert '> Search:' indicator gone
    // Assert filtered list remains (fewer settings)
  });

  it('/ does NOT activate search while editing a setting @requirement:REQ-SEARCH-006', async () => {
    // Navigate to a string/number setting, press Enter to enter edit mode
    // Press '/'
    // Assert search mode is NOT activated
  });

  it('/ does NOT activate search in sub-settings mode @requirement:REQ-SEARCH-007', async () => {
    // Navigate to coreToolSettings, press Enter to enter sub-settings
    // Press '/'
    // Assert search mode is NOT activated
  });

  it('search hint NOT shown in sub-settings mode @requirement:REQ-SEARCH-009', async () => {
    // Enter sub-settings mode
    // Assert '(press / to search)' NOT in header
    // Assert 'parentLabel > Settings' is shown
  });

  it('Ctrl+C is consumed by search mode (does not reset setting) @requirement:REQ-SEARCH-001', async () => {
    // Enter search mode, press Ctrl+C ('\x03')
    // Assert no setting was cleared/reset
  });

  it('existing setting toggle still works after search and clear @requirement:REQ-SEARCH-004', async () => {
    // Regression: search for boolean setting, escape, navigate to it, toggle
    // Assert toggle actually applies (behavioral outcome)
  });
});
```

## Verification Commands

```bash
# Confirm test file has the new describe block
grep -n "fuzzy search" packages/cli/src/ui/components/SettingsDialog.test.tsx

# Confirm plan markers present
grep -r "@plan:PLAN-20250219-GMERGE021.R2.P02" packages/cli/src/ui/components/ | wc -l
# Expected: 13+ occurrences (one per test)

# Run tests — they must FAIL at this point (TDD red phase)
npm test -- --grep "fuzzy search"
# Expected: Tests fail with "not implemented" or similar, NOT "cannot find module"
```

### Structural Verification Checklist

- [ ] 13+ test cases created in new `describe('fuzzy search', ...)` block
- [ ] Each test tagged with plan ID and requirement ID
- [ ] Tests fail naturally (red phase) — not due to import errors
- [ ] No implementation code written yet

### Semantic Verification Checklist

1. **Does each test verify actual behavior (not mocks)?**
   - [ ] Tests check rendered output or state changes, not just that functions were called
2. **Would tests FAIL if implementation was removed?**
   - [ ] Yes — each test asserts rendered text or component state
3. **Are GIVEN/WHEN/THEN scenarios correctly modeled?**
   - [ ] Each test sets up preconditions, performs an action, and checks outcome

## Success Criteria

- All 13 test cases exist and are tagged
- `npm test -- --grep "fuzzy search"` fails with test failures (not errors)
- No implementation code written

## Failure Recovery

1. `git checkout -- packages/cli/src/ui/components/SettingsDialog.test.tsx`
2. Re-read REQ-SEARCH-001 through REQ-SEARCH-010 and rewrite tests

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P02.md`

---

# Phase P03: Implementation

## Phase ID

`PLAN-20250219-GMERGE021.R2.P03`

## Prerequisites

- Required: Phase P02 completed (failing tests exist)
- Verification: `npm test -- --grep "fuzzy search"` exits with failures (not errors)
- Expected files from previous phase: `SettingsDialog.test.tsx` with `describe('fuzzy search', ...)` block

## Requirements Implemented

All REQ-SEARCH-001 through REQ-SEARCH-010 (see Phase P02 for full text).

## Implementation Tasks

### Files to Modify

- `packages/cli/src/ui/components/SettingsDialog.tsx`
  - ADD import: `Fzf` from `'fzf'`
  - ADD state: `isSearching`, `searchQuery`, `filteredKeys`, `searchCursorVisible`
  - ADD effect: search cursor blink interval (tied to `isSearching`)
  - ADD memo: `fzfInstance` built from `{ label, key }` pairs
  - ADD effect: filter `filteredKeys` from `searchQuery` via `fzfInstance`
  - MODIFY: `generateNormalSettingsItems()` — use `filteredKeys` when search active
  - MODIFY: `useKeypress` handler — insert search block after `editingKey` block
  - MODIFY: header JSX — conditional render for search mode vs. normal mode
  - ADD: "No matches found." empty state in item render section
  - MODIFY: sub-settings entry code — clear search state on entry
  - ADD marker: `@plan:PLAN-20250219-GMERGE021.R2.P03` to each changed function

### Required Code Markers

Every changed function/block MUST have a comment:

```typescript
/**
 * @plan PLAN-20250219-GMERGE021.R2.P03
 * @requirement REQ-SEARCH-NNN
 */
```

### Step-by-Step Implementation

#### Step 1 — Import Fzf

Add to existing imports at top of `SettingsDialog.tsx`:

```typescript
import { Fzf } from 'fzf';
```

Note: `fzf` is already in `packages/cli/package.json`. This matches the pattern in `fuzzyFilter.ts`.

#### Step 2 — Add Search State

After existing state declarations (around the `showRestartPrompt` block):

```typescript
// Search state @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-001
const [isSearching, setIsSearching] = useState(false);
const [searchQuery, setSearchQuery] = useState('');
const [filteredKeys, setFilteredKeys] = useState<string[]>(() =>
  getDialogSettingKeys(),
);
// Separate blink state for search cursor (editingKey is null during search,
// so the existing cursorVisible interval is inactive)
const [searchCursorVisible, setSearchCursorVisible] = useState(true);
```

#### Step 3 — Search Cursor Blink Effect

Alongside the existing `cursorVisible` effect:

```typescript
// @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-001
useEffect(() => {
  if (!isSearching) {
    setSearchCursorVisible(true);
    return;
  }
  const id = setInterval(() => setSearchCursorVisible((v) => !v), 500);
  return () => clearInterval(id);
}, [isSearching]);
```

#### Step 4 — Build Fzf Instance (useMemo, Pair Objects)

Use `{ label, key }` pairs to eliminate fragile label→key reverse lookup:

```typescript
// @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-002
const fzfInstance = useMemo(() => {
  const keys = getDialogSettingKeys();
  const pairs = keys
    .map((key) => {
      const def = getSettingDefinition(key);
      return def?.label ? { label: def.label, key } : null;
    })
    .filter((p): p is { label: string; key: string } => p !== null);

  return new Fzf(pairs, {
    selector: (item: { label: string; key: string }) => item.label,
    casing: 'case-insensitive',
  });
}, []); // deps are static (getDialogSettingKeys is pure)
```

#### Step 5 — Search Filter Effect

```typescript
// @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-002
useEffect(() => {
  if (!searchQuery.trim()) {
    setFilteredKeys(getDialogSettingKeys());
    return;
  }
  // fzfInstance is stable (memo deps empty); omitted from dep array intentionally
  const results = fzfInstance.find(searchQuery);
  const matched = results.map((r) => r.item.key);
  setFilteredKeys(matched);
  setActiveSettingIndex(0);
  setScrollOffset(0);
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [searchQuery]);
```

#### Step 6 — Modify `generateNormalSettingsItems`

Replace the `getDialogSettingKeys()` call at the start of `generateNormalSettingsItems`:

```typescript
const generateNormalSettingsItems = () => {
  // @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-002
  // Use filtered keys during active search; fall back to full list otherwise
  const settingKeys =
    isSearching || searchQuery.trim() ? filteredKeys : getDialogSettingKeys();

  return settingKeys.map((key: string) => {
    // ... rest of existing function unchanged ...
  });
};
```

#### Step 7 — Key Handler: Search Block

In `useKeypress`, insert AFTER the `editingKey` block and BEFORE `DIALOG_NAVIGATION_UP/DOWN`:

```typescript
// @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-001,REQ-SEARCH-003,REQ-SEARCH-004
if (isSearching) {
  if (keyMatchers[Command.ESCAPE](key)) {
    setIsSearching(false);
    setSearchQuery('');
    setFilteredKeys(getDialogSettingKeys());
    setActiveSettingIndex(0);
    setScrollOffset(0);
    return;
  }
  if (keyMatchers[Command.RETURN](key)) {
    // Accept current search; exit search UI but keep filter active
    setIsSearching(false);
    return;
  }
  if (name === 'backspace') {
    setSearchQuery((prev) => prev.slice(0, -1));
    return;
  }
  // Allow up/down to fall through to existing navigation logic
  if (
    keyMatchers[Command.DIALOG_NAVIGATION_UP](key) ||
    keyMatchers[Command.DIALOG_NAVIGATION_DOWN](key)
  ) {
    // fall through
  } else if (
    key.sequence &&
    key.sequence.length === 1 &&
    !key.ctrl &&
    !key.meta
  ) {
    setSearchQuery((prev) => prev + key.sequence);
    return;
  } else {
    // Consume all other keys (prevents CLEAR_INPUT, etc.)
    return;
  }
}

// Activate search on '/' @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-001
if (
  !editingKey &&
  !subSettingsMode.isActive &&
  focusSection === 'settings' &&
  key.sequence === '/'
) {
  setIsSearching(true);
  setSearchQuery('');
  return;
}
```

**Critical ordering**: This block is AFTER `editingKey` early-return and BEFORE the digit-intercept. This ensures:
- `/` cannot fire during editing (editingKey block already returned)
- Digits type into search query before hitting number-edit mode

#### Step 8 — Update Header JSX

Replace the header `<Text>` block:

```typescript
{/* @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-001,REQ-SEARCH-009 */}
{isSearching ? (
  <Text bold color={Colors.AccentBlue}>
    {'> Search: '}
    {searchQuery}
    {searchCursorVisible ? '_' : ' '}
  </Text>
) : (
  <Text bold color={Colors.AccentBlue}>
    {subSettingsMode.isActive
      ? `${subSettingsMode.parentLabel} > Settings`
      : (
        <>
          {'Settings  '}
          <Text color={Colors.Gray}>(press / to search)</Text>
        </>
      )}
  </Text>
)}
```

#### Step 9 — "No Matches" Empty State

In the JSX section that renders `visibleItems`:

```typescript
{/* @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-005 */}
{isSearching && filteredKeys.length === 0 && searchQuery.trim() ? (
  <Box>
    <Text color={Colors.Gray}>No matches found.</Text>
  </Box>
) : (
  visibleItems.map((item, idx) => {
    // ... existing item rendering unchanged ...
  })
)}
```

#### Step 10 — Clear Search on Sub-Settings Entry

At the existing `setSubSettingsMode({ isActive: true, ... })` call, add immediately after:

```typescript
// @plan:PLAN-20250219-GMERGE021.R2.P03 @requirement:REQ-SEARCH-007
setIsSearching(false);
setSearchQuery('');
setFilteredKeys(getDialogSettingKeys());
```

## Verification Commands

```bash
# Confirm plan markers in implementation
grep -r "@plan:PLAN-20250219-GMERGE021.R2.P03" \
  packages/cli/src/ui/components/SettingsDialog.tsx | wc -l
# Expected: 10+ occurrences

# Run linter
npm run lint -- --filter packages/cli

# Run type checker
npm run typecheck

# Run all tests (fuzzy search suite must now PASS)
npm test -- --grep "fuzzy search"
# Expected: All 13 tests pass

# Run full test suite (no regressions)
npm test
```

### Deferred Implementation Detection (MANDATORY)

```bash
# No TODOs left in implementation
grep -n "TODO\|FIXME\|HACK\|STUB\|placeholder\|not yet\|will be" \
  packages/cli/src/ui/components/SettingsDialog.tsx | grep -v ".test.ts"
# Expected: No matches from new code

# No empty returns in implementation functions
grep -n "return \[\]\|return {}" \
  packages/cli/src/ui/components/SettingsDialog.tsx
# Expected: No matches in new code
```

### Structural Verification Checklist

- [ ] `Fzf` imported from `'fzf'`
- [ ] 4 new state variables added
- [ ] Search cursor blink effect added
- [ ] `fzfInstance` useMemo with `{ label, key }` pairs
- [ ] `filteredKeys` effect tied to `searchQuery`
- [ ] `generateNormalSettingsItems` uses `filteredKeys` when search active
- [ ] Search block in key handler after editingKey, before digit-intercept
- [ ] Header JSX shows `> Search: {query}_{cursor}` in search mode
- [ ] `(press / to search)` hint hidden in sub-settings mode
- [ ] "No matches found." empty state added
- [ ] Sub-settings entry clears search state

### Semantic Verification Checklist

1. **Does the code DO what the requirements say?**
   - [ ] Read REQ-SEARCH-001 through REQ-SEARCH-010, then read the implementation
   - [ ] Can explain HOW each requirement is fulfilled

2. **Is this REAL implementation, not placeholder?**
   - [ ] Deferred implementation detection passed
   - [ ] No empty returns in new code

3. **Would the tests FAIL if implementation was removed?**
   - [ ] Tests verify rendered text, not just function calls

4. **Is the feature REACHABLE by users?**
   - [ ] Key handler is wired into existing `useKeypress`
   - [ ] UI changes render in the dialog header

5. **What's MISSING?** (list any gaps before proceeding)
   - [ ] _(fill during execution)_

#### Feature Actually Works

```bash
# Manual smoke test (RUN THIS and paste actual output)
node scripts/start.js --profile-load synthetic --prompt "write me a haiku"
# Then open settings (:settings or equivalent)
# Press '/' and verify search mode activates
# Expected: Header shows '> Search: _'
# Actual behavior: [paste here]
```

#### Integration Points Verified

- [ ] `fzfInstance.find(searchQuery)` returns `FzfResultItem<{label,key}>[]` (check type)
- [ ] `r.item.key` correctly resolves back to a settings key string
- [ ] `generateNormalSettingsItems` is called AFTER `filteredKeys` state is set
- [ ] `visibleItems` slicing still correct when `items` is shorter due to filter

## Success Criteria

- All 13 fuzzy search tests pass
- Full test suite passes with no new failures
- Lint and typecheck pass
- Manual smoke test: `/` key shows `> Search: _` in dialog header

## Failure Recovery

1. `git stash` to preserve changes
2. Review key handler ordering — most common failure is incorrect block placement
3. Check `generateNormalSettingsItems` closure — `filteredKeys` must be in scope
4. Cannot proceed to P04 until all 13 tests pass

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P03.md`

---

# Phase P04: Snapshot Update

## Phase ID

`PLAN-20250219-GMERGE021.R2.P04`

## Prerequisites

- Required: Phase P03 completed (all fuzzy search tests pass)
- Verification: `npm test -- --grep "fuzzy search"` exits 0

## Purpose

Update Vitest snapshots to reflect the new `(press / to search)` hint in the header. Snapshot failures here are expected and not a regression — they reflect intentional UI changes.

## Implementation Tasks

### Files to Modify

- `packages/cli/src/ui/components/__snapshots__/SettingsDialog.test.tsx.snap`
  - Updated automatically by running vitest with `--update-snapshots`

### Steps

```bash
# Regenerate all snapshots affected by this change
npm test -- --update-snapshots -- packages/cli/src/ui/components/SettingsDialog.test.tsx
```

Review the diff to confirm:
1. The `(press / to search)` hint appears in normal-mode snapshots
2. Sub-settings-mode snapshots do NOT show the search hint
3. No other unexpected changes appear in the snapshot diff

## Verification Commands

```bash
# Confirm snapshots updated (no pending snapshot failures)
npm test -- packages/cli/src/ui/components/SettingsDialog.test.tsx
# Expected: All pass including snapshot tests

# Review snapshot diff before committing
git diff packages/cli/src/ui/components/__snapshots__/
# Expected: Only '(press / to search)' additions visible
```

### Semantic Verification Checklist

- [ ] Snapshot diff reviewed manually
- [ ] Only expected changes in diff (search hint additions)
- [ ] Sub-settings snapshots do NOT incorrectly include search hint
- [ ] No unrelated snapshot changes (would indicate scope creep)

## Success Criteria

- All snapshot tests pass
- Snapshot diff contains only the expected `(press / to search)` text additions

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P04.md`

---

# Phase P05: Full Verification

## Phase ID

`PLAN-20250219-GMERGE021.R2.P05`

## Prerequisites

- Required: Phase P04 completed (snapshots updated)
- Verification: `npm test` exits 0 with no failures

## Purpose

Run the full project verification suite per repo mandate. This phase is the final gate before marking the implementation complete.

## Verification Commands

Run ALL of these in sequence:

```bash
# 1. Format
npm run format

# 2. Lint
npm run lint

# 3. Type check
npm run typecheck

# 4. Full test suite
npm run test

# 5. Build
npm run build

# 6. Smoke test (haiku + settings check)
node scripts/start.js --profile-load synthetic --prompt "write me a haiku"
```

For step 6, additionally verify interactively (or via automated test if available):
- Open settings dialog
- Observe `(press / to search)` in header
- Press `/` → header changes to `> Search: _`
- Type partial label → list filters
- Press Escape → full list returns

### Structural Verification Checklist

- [ ] `npm run format` exits 0
- [ ] `npm run lint` exits 0
- [ ] `npm run typecheck` exits 0
- [ ] `npm run test` exits 0 (all tests pass)
- [ ] `npm run build` exits 0
- [ ] Smoke test: haiku renders correctly
- [ ] Smoke test: settings search feature works

### Semantic Verification Checklist

1. **All requirements met?**
   - [ ] REQ-SEARCH-001: `/` activates search [OK]
   - [ ] REQ-SEARCH-002: Typing filters in real time [OK]
   - [ ] REQ-SEARCH-003: Backspace edits query [OK]
   - [ ] REQ-SEARCH-004: Escape exits search [OK]
   - [ ] REQ-SEARCH-005: "No matches found." shown [OK]
   - [ ] REQ-SEARCH-006: No search during editing [OK]
   - [ ] REQ-SEARCH-007: No search in sub-settings [OK]
   - [ ] REQ-SEARCH-008: Navigation works during search [OK]
   - [ ] REQ-SEARCH-009: Search hint shown in normal mode [OK]
   - [ ] REQ-SEARCH-010: Enter accepts search [OK]

2. **No regressions?**
   - [ ] Full test suite passes (not just fuzzy search tests)
   - [ ] Settings toggle still works after searching
   - [ ] Sub-settings mode still works
   - [ ] Vim mode integration unaffected

## Success Criteria

- All 6 verification steps exit 0
- All 10 requirements verified as met
- No regressions introduced

## Failure Recovery

1. Identify which step fails and return to P03
2. Do NOT proceed to phase completion until all 6 steps pass
3. For lint/format failures: fix formatting, do not suppress
4. For typecheck failures: fix types, do not use `as any` or `@ts-ignore`

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P05.md`

---

# Phase P06: Risk Review and Out-of-Scope Documentation

## Phase ID

`PLAN-20250219-GMERGE021.R2.P06`

## Prerequisites

- Required: Phase P05 completed (full verification passed)

## Purpose

Document risks and explicitly record what was NOT implemented, for future reference.

## Risk Assessment

| Risk | Level | Mitigation |
|------|-------|------------|
| Key handler ordering incorrect (`/` fires during editing) | Medium | P01 preflight confirms `editingKey` block location; search block placed after |
| Digit keys bypass search and trigger number-edit mode | Medium | Search block placed BEFORE digit intercept; digits type into query |
| `CLEAR_INPUT` (Ctrl+C) fires during search | Medium | Search block consumes all non-navigation keys before existing branches |
| Label→key reverse-lookup ambiguity | Low (eliminated) | `{ label, key }` pair approach removes reverse lookup entirely |
| `filteredKeys` stale when re-entering search | Low | Effect re-runs on `searchQuery` change; entering search clears query |
| Regression in sub-settings mode | Low | Sub-settings entry clears search state; guard prevents `/` in sub-settings |
| Performance (`Fzf` on ~20 items) | Negligible | Synchronous `Fzf` on ~20 settings is instantaneous |

## Out-of-Scope Items (Explicitly NOT Implemented)

1. **`AsyncFzf`**: Not needed. Synchronous `Fzf` is sufficient for a static list of ~20 settings.

2. **Persistent filter after Escape**: The plan clears the filter on Escape (safest default). A "persistent filter" UX (keep results after exiting search mode) would be a separate UX decision.

3. **Tab-key handling while searching**: The plan does not explicitly block Tab during search. Policy decision: either block Tab while `isSearching` (simpler) or allow focus switch to scope selector (may cause confusing split state). Document chosen behavior in test case 13.

4. **Upstream's exact `AsyncFzf` implementation**: Too tied to upstream's simpler architecture. LLxprt's implementation uses the existing `fuzzyFilter.ts` patterns.

5. **Search highlight/decoration**: No character-level match highlighting within labels (upstream didn't add this either).

## Phase Completion Marker

Create: `project-plans/gmerge-0.21.3/.completed/P06.md`
Contents should include paste of final `npm run test` output confirming all tests passed.

---

# Execution Tracker

## Execution Status

| Phase | ID | Status | Started | Completed | Verified | Semantic? | Notes |
|-------|-----|--------|---------|-----------|----------|-----------|-------|
| P01 | `PLAN-20250219-GMERGE021.R2.P01` | ⬜ | - | - | - | N/A | Preflight verification |
| P02 | `PLAN-20250219-GMERGE021.R2.P02` | ⬜ | - | - | - | ⬜ | Failing tests (TDD red) |
| P03 | `PLAN-20250219-GMERGE021.R2.P03` | ⬜ | - | - | - | ⬜ | Implementation (TDD green) |
| P04 | `PLAN-20250219-GMERGE021.R2.P04` | ⬜ | - | - | - | ⬜ | Snapshot update |
| P05 | `PLAN-20250219-GMERGE021.R2.P05` | ⬜ | - | - | - | ⬜ | Full verification suite |
| P06 | `PLAN-20250219-GMERGE021.R2.P06` | ⬜ | - | - | - | N/A | Risk review / out-of-scope |

## Completion Markers

- [ ] All phases have `@plan:PLAN-20250219-GMERGE021.R2` markers in modified code
- [ ] All requirements REQ-SEARCH-001 through REQ-SEARCH-010 have `@requirement` markers
- [ ] Full verification suite (P05) passes
- [ ] No phases skipped
- [ ] Snapshot diff reviewed and approved
