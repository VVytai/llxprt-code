# Reimplementation Plan: Polish Stats Display (Upstream 54de6753)

## Upstream Commit
- **Commit:** 54de67536da3af801bba8ab4657769d54dd30c2a
- **Author:** Jacob Richman <jacob314@gmail.com>
- **Date:** Thu Dec 11 15:17:14 2025 -0800
- **Title:** feat(cli): polish cached token stats and simplify stats display when quota is present

## What Upstream Does

This commit improves the stats display with several polish changes:

### 1. ModelStatsDisplay Changes
- **Rename "Prompt" → "Input"**: Better clarifies that this shows uncached input tokens
- **Show uncached tokens only for "Input"**: Now calculates `Math.max(0, prompt - cached)` 
- **Rename "Cached" → "Cache Reads"**: More descriptive terminology
- **Improve color usage**: 
  - Total tokens: changed from `theme.status.warning` → `theme.text.secondary`
  - Input/Output/Thoughts/Tool: all use `theme.text.primary` (instead of default)
  - Cache Reads: uses `theme.text.secondary` (was `theme.status.success`)

### 2. StatsDisplay Table Changes
- **Add separate columns for uncached and cached tokens** in the Model Usage table
- **Simplify display when quota present**:
  - With quota: shows only "Reqs" and "Usage left" columns (hides token details)
  - Without quota: shows "Reqs", "Input Tokens", "Cache Reads", "Output Tokens"
- **Rename "Usage limit remaining" → "Usage left"**: More concise
- **Remove "FIX" comments**: Clean up old flexGrow workaround comments
- **Add `overflow="hidden"`**: Prevent text overflow issues
- **Add `CACHE_EFFICIENCY` thresholds**: High=40%, Medium=15%
- **Apply status color to cache efficiency percentage** in Savings Highlight
- **Hide Savings Highlight when quota present**: Avoids clutter
- **Restructure table data**: Track `cachedTokens`, `uncachedTokens`, `totalInputTokens` separately
- **Better alignment**: Use `flexDirection="column"` + `alignItems="flex-end"` for columns

### 3. Test Updates
- Update test expectations: "Cached" → "Cache Reads"
- Update snapshot token counts to reflect uncached calculation
- Remove obsolete "Efficiency & Optimizations" expectations
- Update "Usage limit remaining" → "Usage left"

## Why Can't Cherry-Pick

### Theme System Divergence
LLxprt uses a custom theme system (`theme` from `semantic-colors.js`) while upstream uses a different structure. Color references are incompatible:
- Upstream: `theme.text.primary`, `theme.text.secondary`, `theme.status.warning`
- LLxprt: `Colors.Foreground`, `Colors.LightBlue`, `Colors.AccentYellow`, etc.

### Component Structure Differences
1. **ModelStatsDisplay**: LLxprt's version has different StatRow implementation without `isSubtle` rendering, uses fixed colors
2. **StatsDisplay**: 
   - LLxprt has simpler table structure without quota support
   - No `buildModelRows()` helper function
   - No `formatResetTime()` utility
   - Different section organization (has "Token Tracking" section)

### Architecture Differences
- LLxprt doesn't have quota API integration yet
- LLxprt's StatsDisplay doesn't accept a `quotas` prop
- Different runtime context structure

## Implementation Plan

### Phase 1: Update displayUtils.ts
**File:** `packages/cli/src/ui/utils/displayUtils.ts`

**Changes:**
```typescript
// Add cache efficiency thresholds
export const CACHE_EFFICIENCY_HIGH = 40;
export const CACHE_EFFICIENCY_MEDIUM = 15;
```

**Verification:** Threshold constants are exported and available.

---

### Phase 2: Update ModelStatsDisplay.tsx
**File:** `packages/cli/src/ui/components/ModelStatsDisplay.tsx`

**Changes:**

1. **Rename "Prompt" to "Input" and show uncached tokens**:
   ```typescript
   <StatRow
     title="Input"
     isSubtle
     values={getModelValues((m) => (
       <Text color={Colors.Foreground}>
         {Math.max(0, m.tokens.prompt - m.tokens.cached).toLocaleString()}
       </Text>
     ))}
   />
   ```

2. **Rename "Cached" to "Cache Reads"**:
   ```typescript
   {hasCached && (
     <StatRow
       title="Cache Reads"
       isSubtle
       values={getModelValues((m) => {
         const cacheHitRate = calculateCacheHitRate(m);
         return (
           <Text color={Colors.Gray}>  // Changed from Colors.AccentGreen
             {m.tokens.cached.toLocaleString()} ({cacheHitRate.toFixed(1)}%)
           </Text>
         );
       })}
     />
   )}
   ```

3. **Update Total tokens color**:
   ```typescript
   <StatRow
     title="Total"
     values={getModelValues((m) => (
       <Text color={Colors.Gray}>  // Changed from Colors.AccentYellow
         {m.tokens.total.toLocaleString()}
       </Text>
     ))}
   />
   ```

4. **Wrap other token values with explicit colors**:
   ```typescript
   {hasThoughts && (
     <StatRow
       title="Thoughts"
       isSubtle
       values={getModelValues((m) => (
         <Text color={Colors.Foreground}>
           {m.tokens.thoughts.toLocaleString()}
         </Text>
       ))}
     />
   )}
   {hasTool && (
     <StatRow
       title="Tool"
       isSubtle
       values={getModelValues((m) => (
         <Text color={Colors.Foreground}>
           {m.tokens.tool.toLocaleString()}
         </Text>
       ))}
     />
   )}
   <StatRow
     title="Output"
     isSubtle
     values={getModelValues((m) => (
       <Text color={Colors.Foreground}>
         {m.tokens.candidates.toLocaleString()}
       </Text>
     ))}
   />
   ```

**Verification:** Run `/stats model` and verify labels and colors match expectations.

---

### Phase 3: Update ModelStatsDisplay.test.tsx
**File:** `packages/cli/src/ui/components/ModelStatsDisplay.test.tsx`

**Changes:**

1. **Update test expectations "Cached" → "Cache Reads"**:
   ```typescript
   expect(output).not.toContain('Cache Reads');  // line ~119
   expect(output).toContain('Cache Reads');      // line ~171
   ```

2. **Update all snapshots** to reflect:
   - "Prompt" → "Input"
   - "Cached" → "Cache Reads"
   - New uncached token calculations
   - Updated colors

**Verification:** Run test suite and update snapshots with `npm test -- --update`.

---

### Phase 4: Update StatsDisplay.tsx
**File:** `packages/cli/src/ui/components/StatsDisplay.tsx`

**Changes:**

1. **Import cache efficiency thresholds**:
   ```typescript
   import {
     // ... existing imports
     CACHE_EFFICIENCY_HIGH,
     CACHE_EFFICIENCY_MEDIUM,
   } from '../utils/displayUtils.js';
   ```

2. **Remove "FIX" comments** from StatRow and SubStatRow (lines 41, 61):
   ```typescript
   // Before: {/* FIX: Wrap children in a Box... */}
   // After: (just remove the comments)
   {children}
   ```

3. **Update ModelUsageTable to show uncached/cached token split**:
   - Update header to show "Input Tokens" and "Cache Reads" columns (when no quota)
   - Calculate uncached tokens: `Math.max(0, totalInputTokens - cachedTokens)`
   - Display both values in separate columns
   - Use `Colors.Foreground` for uncached, `Colors.Gray` for cached

4. **Apply color to cache efficiency in Savings Highlight**:
   ```typescript
   {cacheEfficiency > 0 && (
     <Box flexDirection="column" marginTop={1}>
       <Text color={Colors.Foreground}>
         <Text color={Colors.AccentGreen}>Savings Highlight:</Text>{' '}
         {totalCachedTokens.toLocaleString()} (
         <Text color={cacheEfficiencyColor}>
           {cacheEfficiency.toFixed(1)}%
         </Text>
         ) of input tokens were served from the cache, reducing costs.
       </Text>
     </Box>
   )}
   ```
   Where `cacheEfficiencyColor` is calculated as:
   ```typescript
   const cacheEfficiencyColor = getStatusColor(cacheEfficiency, {
     green: CACHE_EFFICIENCY_HIGH,
     yellow: CACHE_EFFICIENCY_MEDIUM,
   });
   ```

5. **Add `overflow="hidden"`** to main Box:
   ```typescript
   <Box
     borderStyle="round"
     borderColor={theme.border.default}
     flexDirection="column"
     paddingY={1}
     paddingX={2}
     overflow="hidden"  // Add this
   >
   ```

**Note:** We're NOT implementing quota column changes since LLxprt doesn't have quota API yet. That will be a future enhancement.

**Verification:** Run `/stats` and verify the table layout, colors, and calculations.

---

### Phase 5: Update StatsDisplay.test.tsx
**File:** `packages/cli/src/ui/components/StatsDisplay.test.tsx`

**Changes:**

1. **Update "renders a table with two models correctly" test**:
   - Adjust expected token values to reflect uncached calculation
   - Update snapshot expectations

2. **Remove obsolete test expectations**:
   - Line ~79: Remove `expect(output).not.toContain('Efficiency & Optimizations');`
   - Similar removals in other tests referencing this section

3. **Update all snapshots** to reflect:
   - New table column headers
   - Split input/cache token columns
   - Colored cache efficiency percentage
   - New token calculations

**Verification:** Run full test suite and update snapshots.

---

## Testing Strategy

### Unit Tests
```bash
npm test ModelStatsDisplay.test.tsx
npm test StatsDisplay.test.tsx
```

### Manual Testing
1. Start a session and make API calls with caching
2. Run `/stats` - verify table shows uncached and cached tokens separately
3. Run `/stats model` - verify "Input" shows uncached, "Cache Reads" label present
4. Verify colors match LLxprt's theme (gray for secondary, foreground for primary)
5. Verify cache efficiency percentage has color based on value

### Snapshot Updates
All snapshot files will need updates. Review each snapshot change carefully to ensure:
- Column alignment is preserved
- Token calculations are correct (input = prompt - cached)
- Color codes are appropriate for LLxprt's theme
- No regression in layout or formatting

---

## Files Modified

1. `packages/cli/src/ui/utils/displayUtils.ts` - Add cache efficiency thresholds
2. `packages/cli/src/ui/components/ModelStatsDisplay.tsx` - Rename labels, update colors, calculate uncached tokens
3. `packages/cli/src/ui/components/ModelStatsDisplay.test.tsx` - Update test expectations and snapshots
4. `packages/cli/src/ui/components/StatsDisplay.tsx` - Update table structure, add cache efficiency color, remove FIX comments
5. `packages/cli/src/ui/components/StatsDisplay.test.tsx` - Update test expectations and snapshots
6. `packages/cli/src/ui/components/__snapshots__/ModelStatsDisplay.test.tsx.snap` - All snapshots updated
7. `packages/cli/src/ui/components/__snapshots__/StatsDisplay.test.tsx.snap` - All snapshots updated

---

## Commit Message

```
reimplement: polish stats display (upstream 54de6753)

Improves stats display clarity and visual hierarchy:

- Rename "Prompt" → "Input" to clarify uncached tokens only
- Calculate and display uncached input tokens (prompt - cached)
- Rename "Cached" → "Cache Reads" for better terminology
- Update token display colors for better visual hierarchy:
  - Total: warning → secondary (less emphasis)
  - Input/Output/Thoughts/Tool: explicit primary color
  - Cache Reads: success → secondary (less prominent)
- Add color-coded cache efficiency percentage in Savings Highlight
- Add cache efficiency thresholds (High: 40%, Medium: 15%)
- Clean up outdated "FIX" comments from flexGrow workarounds
- Add overflow="hidden" to prevent text overflow issues

Note: Quota column simplification deferred until quota API integrated.

Adapted from upstream commit 54de67536da3af801bba8ab4657769d54dd30c2a.
Tests updated to match new labels and calculations.
```

---

## Future Work

- **Quota Integration**: When quota API is available, implement the quota column simplification:
  - Show only "Reqs" and "Usage left" when quota present
  - Hide token detail columns when quota present
  - Add "Usage left" header (instead of "Usage limit remaining")
  - Hide "Savings Highlight" when quota present
  - Implement `buildModelRows()` helper to merge active and quota-only models

---

## Scope Notes

**In Scope:**
- Label renames (Prompt→Input, Cached→Cache Reads)
- Uncached token calculation
- Color updates for visual hierarchy
- Cache efficiency color coding
- Test updates and snapshots
- Code cleanup (comments, overflow)

**Out of Scope:**
- Quota column integration (API not available yet)
- Table layout changes for quota mode
- Usage left display format
- Model row merging logic

**Why Manual Reimplement:**
Theme system incompatibility makes clean cherry-pick impossible. Color mappings must be adapted to LLxprt's theme. Quota features require API that doesn't exist yet.
