/**
 * @license
 * Copyright 2025 Vybestack LLC
 * SPDX-License-Identifier: Apache-2.0
 */

/**
 * @plan:PLAN-20260216-HOOKSYSTEMREWRITE.P03
 * @requirement:HOOK-001,HOOK-003,HOOK-004,HOOK-005,HOOK-006,HOOK-007,HOOK-008,HOOK-142
 * @pseudocode:analysis/pseudocode/01-hook-system-lifecycle.md
 */

import type { Config } from '../config/config.js';
import { HookRegistry, type HookRegistryEntry } from './hookRegistry.js';
import { HookPlanner } from './hookPlanner.js';
import { HookRunner } from './hookRunner.js';
import { HookAggregator } from './hookAggregator.js';
import { HookEventHandler } from './hookEventHandler.js';
import { HookSystemNotInitializedError } from './errors.js';
import { DebugLogger } from '../debug/index.js';
import type { MessageBus } from '../confirmation-bus/message-bus.js';

const debugLogger = DebugLogger.getLogger('llxprt:core:hooks:system');

/**
 * HookSystem is the central coordinator for all hook infrastructure.
 * It owns single shared instances of HookRegistry, HookPlanner, HookRunner,
 * HookAggregator, and HookEventHandler, reused across all event fires.
 *
 * @requirement:HOOK-001 - Created lazily on first call to Config.getHookSystem()
 * @requirement:HOOK-003 - Calls HookRegistry.initialize() to load hooks from config
 * @requirement:HOOK-005 - Throws HookSystemNotInitializedError if accessed before initialize()
 * @requirement:HOOK-006 - Exposes getRegistry(), getEventHandler() as public accessors
 * @requirement:HOOK-007 - Trigger functions obtain components from HookSystem, never construct new ones
 * @requirement:HOOK-008 - First hook event fires initialize() before delegating to event handler
 * @requirement:HOOK-142 - Importable from packages/core/src/hooks/hookSystem.ts
 */
export class HookSystem {
  private readonly config: Config;
  private readonly registry: HookRegistry;
  private readonly planner: HookPlanner;
  private readonly runner: HookRunner;
  private readonly aggregator: HookAggregator;
  private eventHandler: HookEventHandler | null = null;

  /**
   * @plan PLAN-20250218-HOOKSYSTEM.P03
   * @requirement DELTA-HSYS-001
   */
  private readonly messageBus: MessageBus | undefined;

  /**
   * @plan PLAN-20250218-HOOKSYSTEM.P03
   * @requirement DELTA-HSYS-001
   */
  private readonly injectedDebugLogger: DebugLogger | undefined;

  /**
   * @plan PLAN-20250218-HOOKSYSTEM.P03
   * @requirement DELTA-HSYS-001
   */
  constructor(
    config: Config,
    messageBus?: MessageBus,
    injectedDebugLogger?: DebugLogger,
  ) {
    this.config = config;
    this.messageBus = messageBus;
    this.injectedDebugLogger = injectedDebugLogger;
    // Create infrastructure components but don't initialize yet
    // @requirement:HOOK-006 - Own single shared instances
    this.registry = new HookRegistry(config);
    this.planner = new HookPlanner(this.registry);
    this.runner = new HookRunner();
    this.aggregator = new HookAggregator();
  }

  /**
   * Initialize the hook system. Must be called before getRegistry() or getEventHandler().
   * Can be called multiple times to reload hooks from config.
   *
   * WARNING: Not safe for concurrent calls. Ensure initialize() completes before
   * calling again. JavaScript is single-threaded but async, so callers must
   * await each initialize() call before starting another.
   *
   * @requirement:HOOK-003 - Calls HookRegistry.initialize() to load hooks from config
   * @requirement:HOOK-008 - Called by trigger functions on first event fire
   */
  async initialize(): Promise<void> {
    debugLogger.debug('Initializing HookSystem');

    // Dispose old event handler to prevent MessageBus subscription leaks.
    // LLxprt enhancement: Upstream Gemini doesn't need this because their
    // HookEventHandler doesn't subscribe to MessageBus. LLxprt added MessageBus
    // integration in PLAN-20250218-HOOKSYSTEM.P03 (DELTA-HEVT-001).
    // Without disposal, each re-init creates a new subscription without
    // unsubscribing the old one, causing memory leaks.
    this.dispose();

    // Initialize the registry (loads hooks from config)
    await this.registry.initialize();

    // Create the event handler now that registry is ready,
    // forwarding injected dependencies per DELTA-HSYS-001
    this.eventHandler = new HookEventHandler(
      this.config,
      this.registry,
      this.planner,
      this.runner,
      this.aggregator,
      this.messageBus,
      this.injectedDebugLogger,
    );

    const totalHooks = this.registry.getAllHooks().length;
    debugLogger.log(
      `HookSystem initialized with ${totalHooks} registered hook(s)`,
    );
  }

  /**
   * Get the hook registry.
   * @throws {HookSystemNotInitializedError} if called before initialize()
   * @requirement:HOOK-005,HOOK-006
   */
  getRegistry(): HookRegistry {
    return this.registry;
  }

  /**
   * Get the hook event handler.
   * @throws {HookSystemNotInitializedError} if called before initialize()
   * @requirement:HOOK-005,HOOK-006
   */
  getEventHandler(): HookEventHandler {
    if (!this.eventHandler) {
      throw new HookSystemNotInitializedError(
        'Cannot access HookEventHandler before HookSystem is initialized',
      );
    }
    return this.eventHandler;
  }

  /**
   * Check if the hook system is initialized.
   */
  isInitialized(): boolean {
    return this.eventHandler !== null;
  }

  /**
   * Enable or disable a specific hook by ID.
   *
   * @plan PLAN-20250218-HOOKSYSTEM.P05
   * @requirement DELTA-HSYS-002
   * @pseudocode message-bus-integration.md lines 30-36
   */
  setHookEnabled(hookId: string, enabled: boolean): void {
    this.registry.setHookEnabled(hookId, enabled);
  }

  /**
   * Return all registered hook definitions.
   *
   * @plan PLAN-20250218-HOOKSYSTEM.P05
   * @requirement DELTA-HSYS-002
   * @pseudocode message-bus-integration.md lines 30-36
   */
  getAllHooks(): HookRegistryEntry[] {
    return this.registry.getAllHooks();
  }

  /**
   * Dispose the HookSystem, releasing any held resources.
   *
   * @plan PLAN-20250218-HOOKSYSTEM.P03
   * @requirement DELTA-HEVT-004
   */
  dispose(): void {
    this.eventHandler?.dispose();
  }
}
